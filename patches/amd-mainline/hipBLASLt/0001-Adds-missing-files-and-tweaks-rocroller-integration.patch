From 3703b2e1591c3b9af7812435157a79c6acb8c8ab Mon Sep 17 00:00:00 2001
From: David Dixon <david.dixon@amd.com>
Date: Wed, 4 Jun 2025 20:35:16 +0000
Subject: [PATCH] Adds missing files and tweaks rocroller integration

---
 next-cmake/CMakeLists.txt                     | 16 ++++++++++
 next-cmake/clients/CMakeLists.txt             |  2 +-
 .../include/tensilelite/CMakeLists.txt        |  2 ++
 .../tensilelite/analytical/CMakeLists.txt     | 32 +++++++++++++++++++
 .../src/tensilelite/CMakeLists.txt            | 13 ++------
 .../src/tensilelite/analytical/CMakeLists.txt | 31 ++++++++++++++++++
 6 files changed, 84 insertions(+), 12 deletions(-)
 create mode 100644 next-cmake/host-library/include/tensilelite/analytical/CMakeLists.txt
 create mode 100644 next-cmake/host-library/src/tensilelite/analytical/CMakeLists.txt

diff --git a/next-cmake/CMakeLists.txt b/next-cmake/CMakeLists.txt
index 34272945..edea1713 100644
--- a/next-cmake/CMakeLists.txt
+++ b/next-cmake/CMakeLists.txt
@@ -277,6 +277,22 @@ if(HIPBLASLT_ENABLE_HOST)
 endif()
 
 if(HIPBLASLT_ENABLE_ROCROLLER)
+    find_package(rocroller)
+    set(ROCROLLER_ENABLE_FETCH ON)
+    set(ROCROLLER_BUILD_TESTING OFF)
+    set(ROCROLLER_ENABLE_CLIENT OFF)
+    option(YAML_CPP_INSTALL "" ON)
+    if(NOT rocroller_FOUND)
+        FetchContent_Declare(
+            rocRoller
+            GIT_REPOSITORY https://github.com/ROCm/rocRoller.git
+            GIT_TAG main
+            SOURCE_SUBDIR next-cmake
+        )
+        FetchContent_MakeAvailable(rocRoller)
+    else()
+        message(FATAL_ERROR "Could not find rocroller")
+    endif()
     target_link_libraries(hipblaslt PRIVATE roc::rocroller)
     target_compile_definitions(hipblaslt PUBLIC HIPBLASLT_USE_ROCROLLER)
 endif()
diff --git a/next-cmake/clients/CMakeLists.txt b/next-cmake/clients/CMakeLists.txt
index 0a284581..ee8d9ee9 100755
--- a/next-cmake/clients/CMakeLists.txt
+++ b/next-cmake/clients/CMakeLists.txt
@@ -58,7 +58,7 @@ target_compile_definitions(hipblaslt-clients-common PRIVATE CLIENTS_NO_FORTRAN)
 
 if(HIPBLASLT_ENABLE_ROCROLLER)
     target_compile_definitions(hipblaslt-clients-common PRIVATE HIPBLASLT_USE_ROCROLLER)
-    target_link_libraries(hipblaslt-clients-common PRIVATE roc::rocroller)
+    target_link_libraries(hipblaslt-clients-common PRIVATE roc::rocroller roc::mxDataGenerator)
 endif()
 if(HIPBLASLT_ENABLE_ASAN)
     hipblaslt_target_configure_sanitizers(hipblaslt-clients-common PUBLIC)
diff --git a/next-cmake/host-library/include/tensilelite/CMakeLists.txt b/next-cmake/host-library/include/tensilelite/CMakeLists.txt
index 02cd30ff..9bdfa7fa 100644
--- a/next-cmake/host-library/include/tensilelite/CMakeLists.txt
+++ b/next-cmake/host-library/include/tensilelite/CMakeLists.txt
@@ -33,6 +33,8 @@ if(HIPBLASLT_ENABLE_HIP)
   add_subdirectory(hip)
 endif()
 
+add_subdirectory(analytical)
+
 set(_CMAKE_CURRENT_SOURCE_DIR "${TEMP_TENSILE_HOST_SOURCE_DIR}/include")
 
 target_sources(hipblaslt
diff --git a/next-cmake/host-library/include/tensilelite/analytical/CMakeLists.txt b/next-cmake/host-library/include/tensilelite/analytical/CMakeLists.txt
new file mode 100644
index 00000000..d1363f92
--- /dev/null
+++ b/next-cmake/host-library/include/tensilelite/analytical/CMakeLists.txt
@@ -0,0 +1,32 @@
+# ########################################################################
+# Copyright (C) 2025 Advanced Micro Devices, Inc.
+#
+# Permission is hereby granted, free of charge, to any person obtaining a copy
+# of this software and associated documentation files (the "Software"), to deal
+# in the Software without restriction, including without limitation the rights
+# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
+# copies of the Software, and to permit persons to whom the Software is
+# furnished to do so, subject to the following conditions:
+#
+# The above copyright notice and this permission notice shall be included in
+# all copies or substantial portions of the Software.
+#
+# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
+# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
+# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
+# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
+# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
+# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
+# THE SOFTWARE.
+#
+# ########################################################################
+
+set(_CMAKE_CURRENT_SOURCE_DIR "${TEMP_TENSILE_HOST_SOURCE_DIR}/include/Tensile/analytical")
+
+target_sources(hipblaslt
+    PRIVATE
+        "${_CMAKE_CURRENT_SOURCE_DIR}/AnalyticalGemm.hpp"
+        "${_CMAKE_CURRENT_SOURCE_DIR}/Hardware.hpp"
+        "${_CMAKE_CURRENT_SOURCE_DIR}/StreamK.hpp"
+        "${_CMAKE_CURRENT_SOURCE_DIR}/Utils.hpp"
+)
diff --git a/next-cmake/host-library/src/tensilelite/CMakeLists.txt b/next-cmake/host-library/src/tensilelite/CMakeLists.txt
index 5b6e2c05..1a13b627 100644
--- a/next-cmake/host-library/src/tensilelite/CMakeLists.txt
+++ b/next-cmake/host-library/src/tensilelite/CMakeLists.txt
@@ -46,17 +46,6 @@ target_sources(hipblaslt
         "${_CMAKE_CURRENT_SOURCE_DIR}/Utils.cpp"
 )
 
-# Need a todo on this and some of the other tensile flags
-#include(CheckCXXCompilerFlag)
-#check_cxx_compiler_flag("-ffast-math" CXX_FAST_MATH_FLAG_SUPPORTED)
-#if(CXX_FAST_MATH_FLAG_SUPPORTED)
-#    set_source_files_properties(MLPNet.cpp PROPERTIES COMPILE_FLAGS "-ffast-math")
-#endif()
-
-#if(WIN32)
-#target_compile_options( TensileHost PUBLIC -Wno-deprecated-declarations -Wno-ignored-attributes -Wdll-attribute-on-redeclaration -fdelayed-template-parsing )
-#endif()
-
 if(HIPBLASLT_ENABLE_LLVM)
   add_subdirectory(llvm)
 endif()
@@ -68,3 +57,5 @@ endif()
 if(HIPBLASLT_ENABLE_HIP)
   add_subdirectory(hip)
 endif()
+
+add_subdirectory(analytical)
diff --git a/next-cmake/host-library/src/tensilelite/analytical/CMakeLists.txt b/next-cmake/host-library/src/tensilelite/analytical/CMakeLists.txt
new file mode 100644
index 00000000..5861253a
--- /dev/null
+++ b/next-cmake/host-library/src/tensilelite/analytical/CMakeLists.txt
@@ -0,0 +1,31 @@
+# ########################################################################
+# Copyright (C) 2025 Advanced Micro Devices, Inc.
+#
+# Permission is hereby granted, free of charge, to any person obtaining a copy
+# of this software and associated documentation files (the "Software"), to deal
+# in the Software without restriction, including without limitation the rights
+# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
+# copies of the Software, and to permit persons to whom the Software is
+# furnished to do so, subject to the following conditions:
+#
+# The above copyright notice and this permission notice shall be included in
+# all copies or substantial portions of the Software.
+#
+# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
+# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
+# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
+# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
+# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
+# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
+# THE SOFTWARE.
+#
+# ########################################################################
+
+set(_CMAKE_CURRENT_SOURCE_DIR "${TEMP_TENSILE_HOST_SOURCE_DIR}/source/analytical")
+
+target_sources(hipblaslt
+    PRIVATE
+        "${_CMAKE_CURRENT_SOURCE_DIR}/AnalyticalGemm.cpp"
+        "${_CMAKE_CURRENT_SOURCE_DIR}/Hardware.cpp"
+        "${_CMAKE_CURRENT_SOURCE_DIR}/Utils.cpp"
+)
-- 
2.43.0

