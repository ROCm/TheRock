From fb18b9b2552839bbc36ea13b64630fb05395984c Mon Sep 17 00:00:00 2001
From: David Dixon <david.dixon@amd.com>
Date: Thu, 11 Sep 2025 11:01:02 +0000
Subject: [PATCH] Enable hipblaslt on windows and for static builds

Co-authored-by: Marius Brehler <marius.brehler@amd.com>
---
 projects/rocblas/CMakeLists.txt                |  2 +-
 projects/rocblas/clients/common/CMakeLists.txt | 12 ++++--------
 projects/rocblas/library/src/CMakeLists.txt    |  8 +-------
 3 files changed, 6 insertions(+), 16 deletions(-)

diff --git a/projects/rocblas/CMakeLists.txt b/projects/rocblas/CMakeLists.txt
index 1ce9ca9e71..6c55a57e5e 100644
--- a/projects/rocblas/CMakeLists.txt
+++ b/projects/rocblas/CMakeLists.txt
@@ -148,7 +148,7 @@ option( BUILD_WITH_HIPBLASLT "Build with HipBLASLt" ON )
 set( hipblaslt_path "/opt/rocm" CACHE PATH "Use local HipBLASLt directory" )
 set( HIPBLASLT_VERSION 1.0.0 CACHE STRING "The version of HipBLASLt to be used" )
 
-if( WIN32 OR NOT BUILD_WITH_TENSILE OR NOT BUILD_SHARED_LIBS )
+if( NOT BUILD_WITH_TENSILE )
   set( BUILD_WITH_HIPBLASLT OFF )
 endif()
 
diff --git a/projects/rocblas/clients/common/CMakeLists.txt b/projects/rocblas/clients/common/CMakeLists.txt
index 99a03bbf78..2c01bdd512 100644
--- a/projects/rocblas/clients/common/CMakeLists.txt
+++ b/projects/rocblas/clients/common/CMakeLists.txt
@@ -54,13 +54,6 @@ function( rocblas_client_library_settings lib_target_ )
     $<BUILD_INTERFACE:${PROJECT_SOURCE_DIR}/common>
   )
 
-  if(BUILD_WITH_HIPBLASLT)
-    target_include_directories( ${lib_target_}
-      SYSTEM BEFORE PRIVATE
-        $<BUILD_INTERFACE:${HIPBLASLT_INCLUDE_DIR}>
-    )
-  endif()
-
   target_compile_definitions( ${lib_target_} PRIVATE ROCM_USE_FLOAT16 ROCBLAS_INTERNAL_API ROCBLAS_NO_DEPRECATED_WARNINGS )
   target_compile_definitions( ${lib_target_} PRIVATE ${TENSILE_DEFINES} ${HIPBLASLT_DEFINES} GOOGLE_TEST )
   # GOOGLE_TEST left off for reuse of this function by by gemm tuner
@@ -169,5 +162,8 @@ target_compile_definitions( rocblas_clients_common PRIVATE ROCBLAS_REFERENCE_LIB
 
 
 # target is not linked as OBJECT library but we want any interface flags from dependencies, e.g. COMMON_LINK_LIBS may bring OpenMP
-target_link_libraries( rocblas_clients_common roc::rocblas hip::host hip::device $<IF:$<TARGET_EXISTS:GTest::gtest>,GTest::gtest,GTest::GTest> $<IF:$<TARGET_EXISTS:GTest::gtest_main>,GTest::gtest_main,GTest::Main> ${COMMON_LINK_LIBS} )
+target_link_libraries( rocblas_clients_common PUBLIC roc::rocblas hip::host hip::device $<IF:$<TARGET_EXISTS:GTest::gtest>,GTest::gtest,GTest::GTest> $<IF:$<TARGET_EXISTS:GTest::gtest_main>,GTest::gtest_main,GTest::Main> ${COMMON_LINK_LIBS} )
+if(BUILD_WITH_HIPBLASLT)
+    target_link_libraries( rocblas_clients_common PRIVATE roc::hipblaslt )
+endif()
 target_link_libraries( rocblas_clients_testing_common roc::rocblas hip::host hip::device ${BLAS_LIBRARY} $<IF:$<TARGET_EXISTS:GTest::gtest>,GTest::gtest,GTest::GTest> $<IF:$<TARGET_EXISTS:GTest::gtest_main>,GTest::gtest_main,GTest::Main> ${COMMON_LINK_LIBS} )
diff --git a/projects/rocblas/library/src/CMakeLists.txt b/projects/rocblas/library/src/CMakeLists.txt
index f4bdfb5f97..12df4f47f3 100644
--- a/projects/rocblas/library/src/CMakeLists.txt
+++ b/projects/rocblas/library/src/CMakeLists.txt
@@ -690,13 +690,7 @@ if( BUILD_WITH_TENSILE )
   endif()
 
   if(BUILD_WITH_HIPBLASLT)
-    target_include_directories( rocblas
-      SYSTEM BEFORE PRIVATE
-        $<BUILD_INTERFACE:${HIPBLASLT_INCLUDE_DIR}>
-    )
-    if( BUILD_SHARED_LIBS )
-      target_link_libraries( rocblas PRIVATE roc::hipblaslt )
-    endif()
+    target_link_libraries( rocblas PRIVATE roc::hipblaslt )
   endif()
 
   if( NOT BUILD_SHARED_LIBS )
-- 
2.43.0

