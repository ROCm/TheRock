From 26d7d8da8f2a091175ac702ea17347bf88a5f825 Mon Sep 17 00:00:00 2001
From: Marius Brehler <marius.brehler@amd.com>
Date: Tue, 26 Aug 2025 16:42:49 +0000
Subject: [PATCH] Revert "fft: compile/link device callback functions with
 -fgpu-rdc (#1103)"

This reverts commit db31de0fb97a0aecbeeaedafa755b50f6f0d5451.
---
 projects/hipfft/clients/samples/CMakeLists.txt       | 12 ++++--------
 projects/hipfft/clients/tests/CMakeLists.txt         |  8 --------
 .../rocfft/clients/samples/rocfft/CMakeLists.txt     |  4 ----
 projects/rocfft/clients/tests/CMakeLists.txt         |  4 ----
 projects/rocfft/docs/how-to/load-store-callbacks.rst |  5 -----
 projects/rocfft/library/src/CMakeLists.txt           |  5 -----
 6 files changed, 4 insertions(+), 34 deletions(-)

diff --git a/projects/hipfft/clients/samples/CMakeLists.txt b/projects/hipfft/clients/samples/CMakeLists.txt
index 6eb7c92f3f..488e09de85 100644
--- a/projects/hipfft/clients/samples/CMakeLists.txt
+++ b/projects/hipfft/clients/samples/CMakeLists.txt
@@ -124,12 +124,8 @@ foreach( sample ${sample_list} )
   
 endforeach()
 
-# callback code must be compiled as relocatable device code
-if( hipfft_callback IN_LIST sample_list )
-  if( BUILD_WITH_LIB STREQUAL "CUDA" )
-    target_compile_options( hipfft_callback PRIVATE -dc )
-  else()
-    target_compile_options( hipfft_callback PRIVATE -fgpu-rdc )
-    target_link_options( hipfft_callback PRIVATE -fgpu-rdc )
-  endif()
+# cuFFT callback code must be compiled with -dc to enable relocatable
+# device code
+if( BUILD_WITH_LIB STREQUAL "CUDA" AND hipfft_callback IN_LIST sample_list )
+  target_compile_options( hipfft_callback PRIVATE -dc )
 endif()
diff --git a/projects/hipfft/clients/tests/CMakeLists.txt b/projects/hipfft/clients/tests/CMakeLists.txt
index a2fed1c3bc..7ce9b49987 100644
--- a/projects/hipfft/clients/tests/CMakeLists.txt
+++ b/projects/hipfft/clients/tests/CMakeLists.txt
@@ -232,14 +232,6 @@ else()
   target_link_libraries( hipfft-test PRIVATE ${GTEST_LIBRARIES} )
 endif()
 
-# tests have callback functions, which need to be built as relocatable device code
-if( BUILD_WITH_LIB STREQUAL "CUDA" )
-  target_compile_options( hipfft-test PRIVATE -dc )
-else()
-  target_compile_options( hipfft-test PRIVATE -fgpu-rdc )
-  target_link_options( hipfft-test PRIVATE -fgpu-rdc )
-endif()
-
 if(FFTW_MULTITHREAD)
   target_compile_options( hipfft-test PRIVATE -DFFTW_MULTITHREAD )
 endif( )
diff --git a/projects/rocfft/clients/samples/rocfft/CMakeLists.txt b/projects/rocfft/clients/samples/rocfft/CMakeLists.txt
index bfea7cea57..d07b22c922 100644
--- a/projects/rocfft/clients/samples/rocfft/CMakeLists.txt
+++ b/projects/rocfft/clients/samples/rocfft/CMakeLists.txt
@@ -116,7 +116,3 @@ foreach( sample ${sample_list} )
   target_link_libraries( ${sample} PRIVATE ${ROCFFT_CLIENTS_HOST_LINK_LIBS} ${ROCFFT_CLIENTS_DEVICE_LINK_LIBS} )
 
 endforeach( )
-
-# callback functions need to be built as relocatable device code
-target_compile_options( rocfft_example_callback PRIVATE -fgpu-rdc )
-target_link_options( rocfft_example_callback PRIVATE -fgpu-rdc )
diff --git a/projects/rocfft/clients/tests/CMakeLists.txt b/projects/rocfft/clients/tests/CMakeLists.txt
index f6e065e93b..3e49f2345a 100644
--- a/projects/rocfft/clients/tests/CMakeLists.txt
+++ b/projects/rocfft/clients/tests/CMakeLists.txt
@@ -100,10 +100,6 @@ add_executable( rtc_helper_crash rtc_helper_crash.cpp )
 # of a mismatch
 target_compile_options( rocfft-test PRIVATE -Xarch_device -O3 )
 
-# callback functions need to be built as relocatable device code
-target_compile_options( rocfft-test PRIVATE -fgpu-rdc )
-target_link_options( rocfft-test PRIVATE -fgpu-rdc )
-
 find_package( Boost REQUIRED )
 set( Boost_DEBUG ON )
 set( Boost_DETAILED_FAILURE_MSG ON )
diff --git a/projects/rocfft/docs/how-to/load-store-callbacks.rst b/projects/rocfft/docs/how-to/load-store-callbacks.rst
index a8ee6ed253..9d37995443 100644
--- a/projects/rocfft/docs/how-to/load-store-callbacks.rst
+++ b/projects/rocfft/docs/how-to/load-store-callbacks.rst
@@ -17,11 +17,6 @@ to the library using
 :cpp:func:`rocfft_execution_info_set_load_callback` and
 :cpp:func:`rocfft_execution_info_set_store_callback`.
 
-.. note::
-
-   Callback functions must be built as relocatable device code by
-   passing the ``-fgpu-rdc`` option to the compiler and linker.
-
 Device functions supplied as callbacks must load and store element
 data types appropriate for the transform being executed.
 
diff --git a/projects/rocfft/library/src/CMakeLists.txt b/projects/rocfft/library/src/CMakeLists.txt
index 69beaa26a2..943facac61 100644
--- a/projects/rocfft/library/src/CMakeLists.txt
+++ b/projects/rocfft/library/src/CMakeLists.txt
@@ -401,11 +401,6 @@ add_library( rocfft
   )
 rocfft_add_coverage_flags( rocfft )
 
-# rocFFT contains default implementations of callback functions that
-# need to be built as relocatable device code
-target_compile_options( rocfft PRIVATE -fgpu-rdc )
-target_link_options( rocfft PRIVATE -fgpu-rdc )
-
 if( ROCFFT_MPI_ENABLE )
   target_compile_definitions(rocfft PRIVATE ROCFFT_MPI_ENABLE)
   include_directories(SYSTEM ${MPI_INCLUDE_PATH})
-- 
2.43.0

