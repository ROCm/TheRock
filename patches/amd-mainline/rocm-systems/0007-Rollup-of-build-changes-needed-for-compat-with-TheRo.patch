From 99d74fc82de0ebf78f0357b29477ea98f00ddb41 Mon Sep 17 00:00:00 2001
From: Stella Laurenzo <stellaraccident@gmail.com>
Date: Mon, 23 Jun 2025 21:38:53 +0000
Subject: [PATCH] Rollup of build changes needed for compat with TheRock.

* When built for a non-default ROCM location, the HIP headers can't be found by a few targets.
* Uses pkg_check for DRM libraries like ROCR-Runtime does (which avoids accidental fallback to system versions).

Co-authored-by: Marius Brehler <marius.brehler@amd.com>
---
 .../cmake/rocprofiler_config_interfaces.cmake | 42 ++++++-------------
 .../source/lib/output/CMakeLists.txt          |  1 +
 .../lib/rocprofiler-sdk-attach/CMakeLists.txt |  1 +
 3 files changed, 14 insertions(+), 30 deletions(-)

diff --git a/projects/rocprofiler-sdk/cmake/rocprofiler_config_interfaces.cmake b/projects/rocprofiler-sdk/cmake/rocprofiler_config_interfaces.cmake
index 4d67246bda..fb1343b966 100644
--- a/projects/rocprofiler-sdk/cmake/rocprofiler_config_interfaces.cmake
+++ b/projects/rocprofiler-sdk/cmake/rocprofiler_config_interfaces.cmake
@@ -131,7 +131,12 @@ if(hip_VERSION VERSION_LESS "6.2")
 endif()
 
 target_link_libraries(rocprofiler-sdk-hip INTERFACE hip::host)
-rocprofiler_config_nolink_target(rocprofiler-sdk-hip-nolink hip::host)
+# TODO: As of 2025/5/29, the hip::host target does not advertise its include directory but
+# amdhip64 does. This ordinarily wouldn't be an issue because most folks just get it
+# transitively, but here this is doing direct property copying to get usage requirements.
+# The proper fix is for hip to export a hip::headers target with only usage requirements
+# and depend on that.
+rocprofiler_config_nolink_target(rocprofiler-sdk-hip-nolink hip::amdhip64)
 
 # ----------------------------------------------------------------------------------------#
 #
@@ -252,35 +257,12 @@ rocprofiler_config_nolink_target(rocprofiler-sdk-hsakmt-nolink hsakmt::hsakmt)
 #
 # ----------------------------------------------------------------------------------------#
 
-find_path(
-    drm_INCLUDE_DIR
-    NAMES drm.h
-    HINTS ${rocm_version_DIR} ${ROCM_PATH} /opt/amdgpu
-    PATHS ${rocm_version_DIR} ${ROCM_PATH} /opt/amdgpu
-    PATH_SUFFIXES include/drm include/libdrm include REQUIRED)
-
-find_path(
-    xf86drm_INCLUDE_DIR
-    NAMES xf86drm.h
-    HINTS ${rocm_version_DIR} ${ROCM_PATH} /opt/amdgpu
-    PATHS ${rocm_version_DIR} ${ROCM_PATH} /opt/amdgpu
-    PATH_SUFFIXES include/drm include/libdrm include REQUIRED)
-
-find_library(
-    drm_LIBRARY
-    NAMES drm
-    HINTS ${rocm_version_DIR} ${ROCM_PATH} /opt/amdgpu
-    PATHS ${rocm_version_DIR} ${ROCM_PATH} /opt/amdgpu REQUIRED)
-
-find_library(
-    drm_amdgpu_LIBRARY
-    NAMES drm_amdgpu
-    HINTS ${rocm_version_DIR} ${ROCM_PATH} /opt/amdgpu
-    PATHS ${rocm_version_DIR} ${ROCM_PATH} /opt/amdgpu REQUIRED)
-
-target_include_directories(rocprofiler-sdk-drm SYSTEM INTERFACE ${drm_INCLUDE_DIR}
-                                                                ${xf86drm_INCLUDE_DIR})
-target_link_libraries(rocprofiler-sdk-drm INTERFACE ${drm_LIBRARY} ${drm_amdgpu_LIBRARY})
+find_package(PkgConfig)
+pkg_check_modules(DRM REQUIRED IMPORTED_TARGET libdrm)
+pkg_check_modules(DRM_AMDGPU REQUIRED IMPORTED_TARGET libdrm_amdgpu)
+target_include_directories(rocprofiler-sdk-drm SYSTEM
+                           INTERFACE ${DRM_INCLUDE_DIRS} ${DRM_AMDGPU_INCLUDE_DIRS})
+target_link_libraries(rocprofiler-sdk-drm INTERFACE PkgConfig::DRM PkgConfig::DRM_AMDGPU)
 
 # ----------------------------------------------------------------------------------------#
 #
diff --git a/projects/rocprofiler-sdk/source/lib/output/CMakeLists.txt b/projects/rocprofiler-sdk/source/lib/output/CMakeLists.txt
index 2a3505a562..055f92fec6 100644
--- a/projects/rocprofiler-sdk/source/lib/output/CMakeLists.txt
+++ b/projects/rocprofiler-sdk/source/lib/output/CMakeLists.txt
@@ -61,6 +61,7 @@ target_link_libraries(
     rocprofiler-sdk-output-library
     PUBLIC rocprofiler-sdk::rocprofiler-sdk-rocpd-library
     PRIVATE rocprofiler-sdk::rocprofiler-sdk-headers
+            rocprofiler-sdk::rocprofiler-sdk-hip-nolink
             rocprofiler-sdk::rocprofiler-sdk-build-flags
             rocprofiler-sdk::rocprofiler-sdk-memcheck
             rocprofiler-sdk::rocprofiler-sdk-common-library
diff --git a/projects/rocprofiler-sdk/source/lib/rocprofiler-sdk-attach/CMakeLists.txt b/projects/rocprofiler-sdk/source/lib/rocprofiler-sdk-attach/CMakeLists.txt
index 5c873215a5..a2cb79323b 100644
--- a/projects/rocprofiler-sdk/source/lib/rocprofiler-sdk-attach/CMakeLists.txt
+++ b/projects/rocprofiler-sdk/source/lib/rocprofiler-sdk-attach/CMakeLists.txt
@@ -23,6 +23,7 @@ target_include_directories(
 target_link_libraries(
     rocprofiler-sdk-attach-shared-library
     PRIVATE rocprofiler-sdk::rocprofiler-sdk-headers
+            rocprofiler-sdk::rocprofiler-sdk-hip-nolink
             rocprofiler-sdk::rocprofiler-sdk-build-flags
             rocprofiler-sdk::rocprofiler-sdk-memcheck
             rocprofiler-sdk::rocprofiler-sdk-common-library
-- 
2.43.0

