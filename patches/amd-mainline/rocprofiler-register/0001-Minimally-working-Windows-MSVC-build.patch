From 674113403c0aab60da777ca63b1a2798a5d7d9ae Mon Sep 17 00:00:00 2001
From: Scott <scott.todd0@gmail.com>
Date: Mon, 31 Mar 2025 20:41:29 +0000
Subject: [PATCH] Minimally working Windows/MSVC build.

---
 source/include/rocprofiler-register/version.h.in     | 10 ++++++++--
 source/lib/rocprofiler-register/CMakeLists.txt       | 12 ++++++++++--
 source/lib/rocprofiler-register/details/dl.cpp       |  8 ++++++++
 source/lib/rocprofiler-register/details/dl.hpp       |  8 ++++++++
 .../lib/rocprofiler-register/details/environment.hpp |  7 ++++++-
 source/lib/rocprofiler-register/details/utility.cpp  |  1 -
 .../rocprofiler-register/rocprofiler_register.cpp    |  8 ++++++++
 7 files changed, 48 insertions(+), 6 deletions(-)

diff --git a/source/include/rocprofiler-register/version.h.in b/source/include/rocprofiler-register/version.h.in
index 7623999..982411c 100644
--- a/source/include/rocprofiler-register/version.h.in
+++ b/source/include/rocprofiler-register/version.h.in
@@ -47,7 +47,13 @@
     ((10000 * ROCPROFILER_REGISTER_VERSION_MAJOR) +                                      \
      (100 * ROCPROFILER_REGISTER_VERSION_MINOR) + ROCPROFILER_REGISTER_VERSION_PATCH)
 
-#define ROCPROFILER_REGISTER_ATTRIBUTE(...)   __attribute__((__VA_ARGS__))
+#if defined(_WIN32) || defined(__CYGWIN__)
+// TODO: implementations on Windows (e.g. `__declspec(dllexport)`)
+#    define ROCPROFILER_REGISTER_ATTRIBUTE(...)
+#else
+#    define ROCPROFILER_REGISTER_ATTRIBUTE(...) __attribute__((__VA_ARGS__))
+#endif
+
 #define ROCPROFILER_REGISTER_PP_COMBINE(X, Y) X##Y
 
 #if defined(rocprofiler_register_EXPORTS)
@@ -86,7 +92,7 @@
 #    endif
 
 #    define ROCPROFILER_REGISTER_STRINGIZE(X)  ROCPROFILER_REGISTER_STRINGIZE2(X)
-#    define ROCPROFILER_REGISTER_STRINGIZE2(X) #    X
+#    define ROCPROFILER_REGISTER_STRINGIZE2(X) #X
 #    define ROCPROFILER_REGISTER_LINESTR       ROCPROFILER_REGISTER_STRINGIZE(__LINE__)
 #    define ROCPROFILER_REGISTER_ESC(...)      __VA_ARGS__
 
diff --git a/source/lib/rocprofiler-register/CMakeLists.txt b/source/lib/rocprofiler-register/CMakeLists.txt
index 840fbed..fe32cc0 100644
--- a/source/lib/rocprofiler-register/CMakeLists.txt
+++ b/source/lib/rocprofiler-register/CMakeLists.txt
@@ -17,12 +17,20 @@ target_include_directories(
     rocprofiler-register PRIVATE ${CMAKE_CURRENT_SOURCE_DIR} ${PROJECT_SOURCE_DIR}/source
                                  ${PROJECT_BINARY_DIR}/source)
 
+
+set(_optional_deps)
+if(NOT WIN32)
+    list(APPEND _optional_deps rocprofiler-register::dl)
+    list(APPEND _optional_deps rocprofiler-register::stdcxxfs)
+else()
+endif()
+
 target_link_libraries(
     rocprofiler-register
     PUBLIC rocprofiler-register::headers
     PRIVATE fmt::fmt glog::glog rocprofiler-register::build-flags
-            rocprofiler-register::memcheck rocprofiler-register::stdcxxfs
-            rocprofiler-register::dl)
+            rocprofiler-register::memcheck
+            ${_optional_deps})
 
 set_target_properties(
     rocprofiler-register
diff --git a/source/lib/rocprofiler-register/details/dl.cpp b/source/lib/rocprofiler-register/details/dl.cpp
index a497dd3..1150e82 100644
--- a/source/lib/rocprofiler-register/details/dl.cpp
+++ b/source/lib/rocprofiler-register/details/dl.cpp
@@ -20,6 +20,12 @@
 // OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 // SOFTWARE.
 
+#if defined(_WIN32) || defined(__CYGWIN__)
+
+// TODO: implement for Windows
+
+#else
+
 #define GNU_SOURCE 1
 
 #include "dl.hpp"
@@ -120,3 +126,5 @@ get_linked_path(std::string_view _name, open_modes_vec_t&& _open_modes)
 }
 }  // namespace binary
 }  // namespace rocprofiler_register
+
+#endif  // defined(_WIN32) || defined(__CYGWIN__)
diff --git a/source/lib/rocprofiler-register/details/dl.hpp b/source/lib/rocprofiler-register/details/dl.hpp
index bfded01..41220aa 100644
--- a/source/lib/rocprofiler-register/details/dl.hpp
+++ b/source/lib/rocprofiler-register/details/dl.hpp
@@ -22,6 +22,12 @@
 
 #pragma once
 
+#if defined(_WIN32) || defined(__CYGWIN__)
+
+// TODO: implement for Windows
+
+#else
+
 #include <cstdint>
 #include <optional>
 #include <string>
@@ -58,3 +64,5 @@ std::optional<std::string>
 get_linked_path(std::string_view, open_modes_vec_t&& = {});
 }  // namespace binary
 }  // namespace rocprofiler_register
+
+#endif  // defined(_WIN32) || defined(__CYGWIN__)
diff --git a/source/lib/rocprofiler-register/details/environment.hpp b/source/lib/rocprofiler-register/details/environment.hpp
index a0f10b5..941ee0b 100644
--- a/source/lib/rocprofiler-register/details/environment.hpp
+++ b/source/lib/rocprofiler-register/details/environment.hpp
@@ -23,7 +23,7 @@
 #include <fmt/core.h>
 #include <glog/logging.h>
 
-#include <unistd.h>
+#include <stdlib.h>
 #include <cstdio>
 #include <cstdlib>
 #include <cstring>
@@ -157,7 +157,12 @@ struct env_config
         if(env_name.empty()) return -1;
         LOG(INFO) << fmt::format(
             "setenv({}, {}, {})", env_name.c_str(), env_value.c_str(), overwrite);
+#if defined(_WIN32) || defined(__CYGWIN__)
+        // TODO: Windows implementation?
+        return -1;
+#else
         return setenv(env_name.c_str(), env_value.c_str(), overwrite);
+#endif
     }
 };
 }  // namespace common
diff --git a/source/lib/rocprofiler-register/details/utility.cpp b/source/lib/rocprofiler-register/details/utility.cpp
index cc9e9fc..930d542 100644
--- a/source/lib/rocprofiler-register/details/utility.cpp
+++ b/source/lib/rocprofiler-register/details/utility.cpp
@@ -26,7 +26,6 @@
 #include <string_view>
 
 #include <sys/types.h>
-#include <unistd.h>
 
 namespace rocprofiler_register
 {
diff --git a/source/lib/rocprofiler-register/rocprofiler_register.cpp b/source/lib/rocprofiler-register/rocprofiler_register.cpp
index df9631e..5767eba 100644
--- a/source/lib/rocprofiler-register/rocprofiler_register.cpp
+++ b/source/lib/rocprofiler-register/rocprofiler_register.cpp
@@ -41,6 +41,12 @@
 #include <string_view>
 #include <utility>
 
+#if defined(_WIN32) || defined(__CYGWIN__)
+
+// TODO: Do something sensible on Windows (at least implement APIs with no-ops)
+
+#else
+
 #include <dlfcn.h>
 #include <unistd.h>
 
@@ -661,3 +667,5 @@ rocprofiler_register_invoke_all_registrations()
     return rocp_invoke_registrations(true);
 }
 }
+
+#endif  // defined(_WIN32) || defined(__CYGWIN__)
-- 
2.43.0

