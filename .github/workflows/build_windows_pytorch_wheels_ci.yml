# CI variant of build_windows_pytorch_wheels.yml.
#
# Key differences from the release workflow:
#   - Installs ROCm packages via --find-links (CI artifacts) instead of
#     --index-url (release index)
#   - Builds torch only (no torchvision, torchaudio)
#   - No S3 upload, staging, testing, or promotion â€” just build + sanity check
#
# TODO(#3291): Build more packages (torchvision, torchaudio, etc.)
# TODO(#3291): Upload packages to S3 (via upload_python_packages.py?)
#
# Both workflows share build_prod_wheels.py for the actual build logic.
# See https://github.com/ROCm/TheRock/issues/3291 for convergence plans.

name: Build Windows PyTorch Wheels (CI)

on:
  workflow_call:
    inputs:
      artifact_group:
        type: string
        required: true
      python_version:
        type: string
        default: "3.12"
      pytorch_git_ref:
        description: PyTorch ref to checkout (typically "release/X.Y")
        type: string
        default: "release/2.10"
      rocm_package_find_links_url:
        description: URL for pip --find-links to install ROCm packages
        type: string
        required: true
      rocm_version:
        description: ROCm package version to install and build against (e.g. 7.10.0.dev0)
        type: string
        required: true
      cache_type:
        description: "Compiler cache type: sccache (S3-backed), ccache, or none"
        type: string
        default: "sccache"
  workflow_dispatch:
    inputs:
      artifact_group:
        description: "The artifact group to build (e.g. gfx110X-all, gfx120X-all)"
        type: string
        default: gfx1151
      python_version:
        type: string
        default: "3.12"
      pytorch_git_ref:
        description: PyTorch ref to checkout (typically "release/X.Y")
        type: string
        default: "release/2.10"
      rocm_package_find_links_url:
        description: URL for pip --find-links to install ROCm packages
        type: string
        required: true
      rocm_version:
        description: ROCm package version to install and build against (e.g. 7.10.0.dev0)
        type: string
        required: true
      cache_type:
        description: "Compiler cache type: sccache (S3-backed), ccache, or none"
        type: choice
        options:
          - sccache
          - ccache
          - none
        default: sccache

permissions:
  id-token: write
  contents: read

run-name: Build Windows PyTorch Wheels CI (${{ inputs.artifact_group }}, py${{ inputs.python_version }}, ${{ inputs.pytorch_git_ref }})

jobs:
  build_pytorch_wheels:
    name: Build PyTorch | ${{ inputs.artifact_group }} | torch ${{ inputs.pytorch_git_ref }} | py${{ inputs.python_version }}
    runs-on: ${{ github.repository_owner == 'ROCm' && 'azure-windows-scale-rocm' || 'windows-2022' }}
    env:
      CHECKOUT_ROOT: B:/src
      # Note the \ here instead of /. This should be used from 'cmd' not 'bash'!
      PACKAGE_DIST_DIR: ${{ github.workspace }}\output\packages\dist
      optional_build_prod_arguments: ""
      SCCACHE_BUCKET: therock-sccache
      SCCACHE_REGION: us-east-2
      SCCACHE_S3_KEY_PREFIX: "windows/${{ inputs.artifact_group }}/"
      SCCACHE_S3_USE_SSL: "true"
      SCCACHE_IDLE_TIMEOUT: "0"
    defaults:
      run:
        # Note: there are mixed uses of 'bash' (this default) and 'cmd' below
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Configure Git Identity
        run: |
          git config --global user.name "therockbot"
          git config --global user.email "therockbot@amd.com"

      - uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: ${{ inputs.python_version }}

      - name: Select Python version
        run: |
          python build_tools/github_actions/python_to_cp_version.py \
            --python-version ${{ inputs.python_version }}

      # TODO(amd-justchen): share with build_windows_artifacts.yml. Include in VM image? Dockerfile?
      - name: Install requirements
        run: |
          choco install --no-progress -y ninja --version 1.13.1

      - name: Install sccache
        if: ${{ inputs.cache_type == 'sccache' }}
        run: |
          choco install --no-progress -y sccache
          echo "sccache version: $(sccache --version)"

      # After other installs, so MSVC gets priority in the PATH.
      - name: Configure MSVC
        uses: ilammy/msvc-dev-cmd@0b201ec74fa43914dc39ae48a89fd1d8cb592756 # v1.13.0

      - name: Checkout PyTorch source (nightly)
        if: ${{ inputs.pytorch_git_ref == 'nightly' }}
        run: |
          git config --global core.longpaths true
          python ./external-builds/pytorch/pytorch_torch_repo.py checkout \
            --checkout-dir ${{ env.CHECKOUT_ROOT }}/torch \
            --repo-hashtag nightly

      - name: Checkout PyTorch source (stable)
        if: ${{ inputs.pytorch_git_ref != 'nightly' }}
        run: |
          git config --global core.longpaths true
          python ./external-builds/pytorch/pytorch_torch_repo.py checkout \
            --checkout-dir ${{ env.CHECKOUT_ROOT }}/torch \
            --gitrepo-origin https://github.com/ROCm/pytorch.git \
            --repo-hashtag ${{ inputs.pytorch_git_ref }}

      # Note: determine_version.py sets optional_build_prod_arguments in
      # GITHUB_ENV, which includes --rocm-sdk-version and --version-suffix.
      - name: Determine optional arguments passed to `build_prod_wheels.py`
        if: ${{ inputs.rocm_version }}
        run: |
          pip install packaging
          python build_tools/github_actions/determine_version.py \
            --rocm-version ${{ inputs.rocm_version }}

      - name: Configure AWS Credentials for sccache
        if: ${{ inputs.cache_type == 'sccache' && github.repository_owner == 'ROCm' }}
        uses: aws-actions/configure-aws-credentials@8df5847569e6427dd6c4fb1cf565c83acfa8afa7 # v6.0.0
        with:
          aws-region: us-east-2
          role-to-assume: arn:aws:iam::692859939525:role/therock-sccache
          special-characters-workaround: true

      - name: Verify sccache
        if: ${{ inputs.cache_type == 'sccache' }}
        run: |
          echo "sccache version: $(sccache --version)"
          echo "SCCACHE_BUCKET=${SCCACHE_BUCKET}"
          echo "SCCACHE_S3_KEY_PREFIX=${SCCACHE_S3_KEY_PREFIX}"

      # Using 'cmd' here is load bearing! There are configuration issues when
      # run under 'bash': https://github.com/ROCm/TheRock/issues/827#issuecomment-3025858800
      - name: Build PyTorch wheels
        shell: cmd
        run: |
          set "CACHE_FLAG="
          if "${{ inputs.cache_type }}"=="sccache" set "CACHE_FLAG=--use-sccache"
          if "${{ inputs.cache_type }}"=="ccache" set "CACHE_FLAG=--use-ccache"

          echo "Building PyTorch wheels for ${{ inputs.artifact_group }} (cache: ${{ inputs.cache_type }})"
          python ./external-builds/pytorch/build_prod_wheels.py ^
            build ^
            --install-rocm ^
            --find-links "${{ inputs.rocm_package_find_links_url }}" ^
            --pytorch-dir ${{ env.CHECKOUT_ROOT }}/torch ^
            --enable-pytorch-flash-attention-windows ^
            --clean ^
            --output-dir ${{ env.PACKAGE_DIST_DIR }} ^
            %CACHE_FLAG% ^
            ${{ env.optional_build_prod_arguments }}

      - name: Report cache stats
        if: ${{ !cancelled() && inputs.cache_type != 'none' }}
        run: |
          if [ "${{ inputs.cache_type }}" = "sccache" ]; then
            echo "sccache stats:"
            echo "--------------"
            sccache --show-stats
          elif [ "${{ inputs.cache_type }}" = "ccache" ]; then
            echo "ccache stats:"
            echo "-------------"
            ccache -s -v
          fi

      - name: Sanity check wheel
        shell: cmd
        run: |
          python external-builds/pytorch/sanity_check_wheel.py ${{ env.PACKAGE_DIST_DIR }}
