name: Demo - Unified Logging with Rocroller (Prebuilt Artifacts)

on:
  workflow_dispatch:
    inputs:
      artifact_run_id:
        description: 'Artifact Run ID to download test binaries from (prebuilt - no compilation)'
        required: true
        default: '20151692873'
        type: string
      test_type:
        description: 'Test type'
        required: true
        default: 'smoke'
        type: choice
        options:
          - smoke
          - regression
          - full

permissions:
  contents: read

jobs:
  demo_rocroller:
    name: 'Demo Unified Logging - Rocroller'
    runs-on: linux-mi325-1gpu-ossci-rocm-frac
    timeout-minutes: 45
    container:
      image: ghcr.io/rocm/no_rocm_image_ubuntu24_04@sha256:4150afe4759d14822f0e3f8930e1124f26e11f68b5c7b91ec9a02b20b1ebbb98
      options: --ipc host
        --group-add video
        --device /dev/kfd
        --device /dev/dri
        --group-add 110
        --env-file /etc/podinfo/gha-gpu-isolation-settings
        --user 0:0
    
    env:
      ARTIFACT_RUN_ID: ${{ github.event.inputs.artifact_run_id || '20151692873' }}
      ARTIFACT_GROUP: "gfx94X-dcgpu"
      COMPONENT: "rocroller"
      TEST_TYPE: ${{ github.event.inputs.test_type || 'smoke' }}
      VENV_DIR: ${{ github.workspace }}/.venv
      OUTPUT_ARTIFACTS_DIR: "./build"
      THEROCK_BIN_DIR: "./build/bin"
      THEROCK_BUILD_DIR: "./build"
      AMDGPU_FAMILIES: "gfx94X"
      RUNNER_OS: "Linux"
      SHARD_INDEX: "1"
      TOTAL_SHARDS: "1"
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: users/rponnuru/logging_poc_2
      
      - name: Display Demo Info
        run: |
          echo "=========================================="
          echo "üéØ Unified Logging Framework Demo"
          echo "=========================================="
          echo ""
          echo "‚ö° FAST DEMO - Using Prebuilt Artifacts"
          echo "   No ROCm compilation required!"
          echo ""
          echo "üñ•Ô∏è  Runner: linux-mi325-1gpu-ossci-rocm-frac (MI325)"
          echo "üì¶ Component: rocroller"
          echo "üß™ Test Type: $TEST_TYPE"
          echo "üì• Artifact Run ID: $ARTIFACT_RUN_ID (prebuilt binaries)"
          echo ""
          echo "üìã Key Features to Observe:"
          echo "  ‚Ä¢ Unified log format across all outputs"
          echo "  ‚Ä¢ Context tracking (component, operation)"
          echo "  ‚Ä¢ Performance timing with timed_operation()"
          echo "  ‚Ä¢ Structured logging with metadata"
          echo "  ‚Ä¢ Real test execution on actual GPU"
          echo ""
          echo "‚è±Ô∏è  Expected Duration: ~5-10 minutes"
          echo "   (downloads prebuilt binaries, no compilation)"
          echo ""
          echo "=========================================="
      
      - name: Download Test Artifacts
        uses: './.github/actions/setup_test_environment'
        with:
          ARTIFACT_RUN_ID: ${{ env.ARTIFACT_RUN_ID }}
          ARTIFACT_GROUP: ${{ env.ARTIFACT_GROUP }}
          OUTPUT_ARTIFACTS_DIR: ${{ env.OUTPUT_ARTIFACTS_DIR }}
          VENV_DIR: ${{ env.VENV_DIR }}
          FETCH_ARTIFACT_ARGS: '--blas --tests'
          IS_PR_FROM_FORK: false
      
      - name: Run Rocroller Tests with Unified Logging
        run: |
          echo ""
          echo "=========================================="
          echo "üöÄ Running Rocroller Tests"
          echo "=========================================="
          echo ""
          echo "This demonstrates the unified logging framework with:"
          echo "  - Real GTest execution"
          echo "  - Structured log output"
          echo "  - Performance timing"
          echo "  - Context-aware logging"
          echo ""
          
          # Run the test script which uses unified logging framework
          python3 build_tools/github_actions/test_executable_scripts/test_rocroller.py
      
      - name: Demo Summary
        if: always()
        run: |
          echo ""
          echo "=========================================="
          echo "üìä Demo Summary - Rocroller"
          echo "=========================================="
          echo ""
          echo "‚ö° FAST DEMO COMPLETE - Used Prebuilt Artifacts"
          echo ""
          echo "‚úÖ Demonstrated Features:"
          echo ""
          echo "1Ô∏è‚É£  Real Test Execution (No Build Required!)"
          echo "   ‚Ä¢ Ran actual rocroller tests on MI325 GPU"
          echo "   ‚Ä¢ Downloaded prebuilt artifacts from Run ID: $ARTIFACT_RUN_ID"
          echo "   ‚Ä¢ Used real GTest binaries (no compilation time)"
          echo ""
          echo "2Ô∏è‚É£  Unified Logging Framework"
          echo "   ‚Ä¢ Single LOG_FORMAT: timestamp - logger - level - message"
          echo "   ‚Ä¢ Consistent across console and file output"
          echo "   ‚Ä¢ No environment-specific code"
          echo ""
          echo "3Ô∏è‚É£  TestRunner Integration"
          echo "   ‚Ä¢ Captures GTest output"
          echo "   ‚Ä¢ Parses test results"
          echo "   ‚Ä¢ Structured logging with context"
          echo "   ‚Ä¢ Built-in performance timing"
          echo ""
          echo "4Ô∏è‚É£  Context & Metadata"
          echo "   ‚Ä¢ Component: $COMPONENT"
          echo "   ‚Ä¢ Test Type: $TEST_TYPE"
          echo "   ‚Ä¢ GPU: gfx94X (MI325)"
          echo "   ‚Ä¢ Structured metadata in log records"
          echo ""
          echo "5Ô∏è‚É£  Simplicity"
          echo "   ‚Ä¢ No GitHub Actions-specific code"
          echo "   ‚Ä¢ No JSON formatting complexity"
          echo "   ‚Ä¢ Works same in local, CI, and GitHub Actions"
          echo "   ‚Ä¢ Single unified approach everywhere"
          echo ""
          echo "üìÅ Key Files:"
          echo "   ‚Ä¢ logging_config.py - Core framework"
          echo "   ‚Ä¢ test_runner.py - Test execution wrapper"
          echo "   ‚Ä¢ test_rocroller.py - Component test script"
          echo ""
          echo "=========================================="

