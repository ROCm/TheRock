name: Strix AI/ML Testing

# Runs automatically on push/PR to Strix test files, or manually on demand
on:
  # Automatic triggers
  push:
    branches:
      - 'users/*/strix_*'      # Any user's strix branch
      - 'main'                  # Main branch
      - 'develop'               # Develop branch
    paths:
      - 'tests/strix_ai/**'     # Strix AI tests
      - '.github/workflows/strix_ai*.yml'  # This workflow
      - 'build_tools/_therock_utils/**'    # Utilities used by tests
  
  pull_request:
    branches:
      - 'main'
      - 'develop'
    paths:
      - 'tests/strix_ai/**'
      - '.github/workflows/strix_ai*.yml'
  
  # Manual trigger with options
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to test'
        required: true
        type: choice
        options:
          - linux
          - windows
        default: 'linux'
      
      strix_variant:
        description: 'Strix GPU variant'
        required: true
        type: choice
        options:
          - gfx1150  # Strix Point
          - gfx1151  # Strix Halo
        default: 'gfx1151'
      
      test_category:
        description: 'Test category to run'
        required: true
        type: choice
        options:
          - all       # Run all tests
          - vlm       # Vision Language Models
          - vla       # Vision Language Action
          - vit       # Vision Transformers
          - cv        # Computer Vision
          - optimization  # Quantization & optimization
          - quick     # Quick smoke tests only
        default: 'quick'
      
      test_type:
        description: 'Test execution type'
        required: true
        type: choice
        options:
          - smoke     # Quick validation
          - quick     # Reduced test set
          - full      # Complete test suite
        default: 'quick'
      
      runner_label:
        description: 'GitHub runner label (leave default unless testing)'
        required: false
        type: string
        default: ''
      
      artifact_run_id:
        description: 'Artifact run ID (leave empty for latest)'
        required: false
        type: string
        default: ''

permissions:
  contents: read

jobs:
  strix_ai_test:
    name: Strix AI Tests
    runs-on: ${{ github.event.inputs.runner_label || ((github.event.inputs.platform || 'linux') == 'linux' && 'linux-strix-halo-gpu-rocm' || 'windows-strix-halo-gpu-rocm') }}
    timeout-minutes: 120
    
    # Linux: Use container with ROCm pre-installed
    # Note: Using rocm/dev-ubuntu-24.04 which includes ROCm runtime and development tools
    container:
      image: ${{ (github.event.inputs.platform || 'linux') == 'linux' && 'rocm/dev-ubuntu-24.04:latest' || null }}
      options: ${{ (github.event.inputs.platform || 'linux') == 'linux' && '--ipc host --group-add video --device /dev/kfd --device /dev/dri --group-add 110 --user 0:0' || '' }}
    
    defaults:
      run:
        shell: bash
    
    env:
      VENV_DIR: ${{ github.workspace }}/.venv
      ARTIFACT_RUN_ID: ${{ github.event.inputs.artifact_run_id || github.run_id }}
      OUTPUT_ARTIFACTS_DIR: ${{ github.workspace }}/build
      THEROCK_BIN_DIR: ${{ github.workspace }}/build/bin
      AMDGPU_FAMILIES: ${{ github.event.inputs.strix_variant || 'gfx1151' }}
      TEST_TYPE: ${{ github.event.inputs.test_type || 'quick' }}
      TEST_CATEGORY: ${{ github.event.inputs.test_category || 'quick' }}
      PLATFORM: ${{ github.event.inputs.platform || 'linux' }}
      PYTHONUNBUFFERED: 1
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          repository: "ROCm/TheRock"
          ref: ${{ github.ref }}
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Display System Info
        run: |
          echo "=== Strix AI Test Run ==="
          echo "Trigger: ${{ github.event_name }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Platform: ${{ env.PLATFORM }}"
          echo "Strix Variant: ${{ env.AMDGPU_FAMILIES }}"
          echo "Test Category: ${{ env.TEST_CATEGORY }}"
          echo "Test Type: ${{ env.TEST_TYPE }}"
          echo "Runner: ${{ runner.name }}"
          echo ""
          echo "=== Python Info ==="
          python --version
          pip --version
      
      # Linux-specific: Check GPU and ROCm
      - name: Check ROCm/GPU (Linux)
        if: env.PLATFORM == 'linux'
        run: |
          echo "=== Container/System Info ==="
          cat /etc/os-release || true
          uname -a
          
          echo ""
          echo "=== ROCm Info ==="
          if command -v rocminfo &> /dev/null; then
            echo "✓ ROCm is installed!"
            rocminfo | head -50
          else
            echo "✗ WARNING: rocminfo not found in PATH"
            echo "This means ROCm is NOT installed in the container"
            echo "AI/ML tests may not be able to use the GPU"
          fi
          
          echo ""
          echo "=== HIP Info ==="
          if command -v hipconfig &> /dev/null; then
            echo "✓ HIP is available"
            hipconfig --version || true
          else
            echo "✗ WARNING: HIP not found"
          fi
          
          echo ""
          echo "=== GPU Devices ==="
          ls -la /dev/kfd /dev/dri/ || echo "GPU devices not accessible"
          
          echo ""
          echo "=== ROCm Environment Variables ==="
          env | grep -i rocm || echo "No ROCm env vars set"
          
          echo ""
          echo "=== Checking for ROCm Libraries ==="
          ldconfig -p | grep -i "rocm\|hip\|hsa" | head -20 || echo "No ROCm libraries found in ldconfig"
      
      # Windows-specific: Check GPU
      - name: Check GPU (Windows)
        if: env.PLATFORM == 'windows'
        run: |
          Write-Host "=== GPU Info ==="
          Get-WmiObject Win32_VideoController | Select-Object Name, DriverVersion
          
          Write-Host "=== Environment ==="
          Get-ChildItem Env: | Where-Object { $_.Name -like "*ROCM*" -or $_.Name -like "*HIP*" }
      
      - name: Setup Test Environment
        # Optional: Fetch pre-built TheRock artifacts
        # For AI/ML tests, this is not strictly required as tests can run standalone
        continue-on-error: true
        uses: './.github/actions/setup_test_environment'
        with:
          ARTIFACT_RUN_ID: ${{ env.ARTIFACT_RUN_ID }}
          ARTIFACT_GROUP: ${{ env.PLATFORM }}_release_${{ env.AMDGPU_FAMILIES }}
          OUTPUT_ARTIFACTS_DIR: ${{ env.OUTPUT_ARTIFACTS_DIR }}
          VENV_DIR: ${{ env.VENV_DIR }}
          FETCH_ARTIFACT_ARGS: "--pytorch --tests"
          IS_PR_FROM_FORK: false
      
      - name: Install AI/ML Dependencies
        run: |
          echo "=== Installing AI/ML Dependencies ==="
          echo "Note: AI/ML tests run standalone and don't require TheRock build"
          echo "Tests validate PyTorch, Transformers, and CV libraries on Strix GPU"
          echo ""
          
          # Deactivate venv and use system python3
          unset VIRTUAL_ENV
          export PATH=$(echo $PATH | sed 's|/__w/TheRock/TheRock/.venv/bin:||')
          
          /usr/bin/python3 -m pip install --upgrade pip --user
          /usr/bin/python3 -m pip install pytest pytest-check --user
          
          echo "Installing transformers and accelerate..."
          /usr/bin/python3 -m pip install transformers accelerate --user || echo "WARNING: transformers install failed"
          
          echo "Installing computer vision libraries..."
          /usr/bin/python3 -m pip install ultralytics opencv-python pillow --user || echo "WARNING: CV libs install failed"
          
          echo "Installing torch and torchvision with ROCm support..."
          # Install PyTorch with ROCm 6.2 support (adjust version as needed)
          /usr/bin/python3 -m pip install torch torchvision --index-url https://download.pytorch.org/whl/rocm6.2 --user || \
          /usr/bin/python3 -m pip install torch torchvision --user || \
          echo "WARNING: torch installation failed (may skip GPU tests)"
          
          echo "Installing additional dependencies..."
          /usr/bin/python3 -m pip install timm einops scipy matplotlib --user || echo "WARNING: Additional deps install failed"
          
          echo ""
          echo "SUCCESS: Dependency installation complete (check warnings above)"
      
      - name: Verify Dependencies
        run: |
          unset VIRTUAL_ENV
          echo "=== Installed Python Packages ==="
          /usr/bin/python3 -m pip list | grep -E "pytest|transformers|torch|ultralytics" || echo "Some packages may not be installed"
          
          echo ""
          echo "=== PyTorch GPU Check ==="
          /usr/bin/python3 <<'PYTHON_SCRIPT' || echo "PyTorch verification failed"
import sys
try:
    import torch
    print(f"PyTorch {torch.__version__} imported successfully")
    print(f"  CUDA available: {torch.cuda.is_available()}")
    if torch.cuda.is_available():
        print(f"  Device count: {torch.cuda.device_count()}")
        print(f"  Device name: {torch.cuda.get_device_name(0)}")
        print(f"  Device capability: {torch.cuda.get_device_capability(0)}")
    else:
        print("  WARNING: CUDA/ROCm not available to PyTorch")
        print("  GPU tests will be skipped")
except Exception as e:
    print(f"ERROR: Failed to import torch: {e}")
    sys.exit(0)
PYTHON_SCRIPT
      
      - name: Verify TheRock Installation
        continue-on-error: true
        run: |
          echo "Checking THEROCK_BIN_DIR: ${{ env.THEROCK_BIN_DIR }}"
          
          if [ -d "${{ env.THEROCK_BIN_DIR }}" ]; then
            echo "SUCCESS: Build directory exists"
            ls -la ${{ env.THEROCK_BIN_DIR }} || true
            
            # Try to run rocminfo if available
            if [ -f "${{ env.THEROCK_BIN_DIR }}/rocminfo" ]; then
              echo "Running rocminfo..."
              ${{ env.THEROCK_BIN_DIR }}/rocminfo | head -20 || true
            else
              echo "WARNING: rocminfo not found in build"
            fi
          else
            echo "WARNING: Build directory not found - tests will use system ROCm (if available)"
            echo "This is OK for AI/ML tests that primarily need PyTorch"
            
            # Check for system rocminfo
            if command -v rocminfo &> /dev/null; then
              echo "SUCCESS: System rocminfo found"
              rocminfo | head -20 || true
            else
              echo "INFO: No rocminfo available"
            fi
          fi
      
      - name: Run Strix AI Tests - All
        if: env.TEST_CATEGORY == 'all'
        run: |
          unset VIRTUAL_ENV
          /usr/bin/python3 -m pytest tests/strix_ai/ -v -s \
            --junit-xml=test-results-all.xml \
            -m "not slow" \
            || exit 0
      
      - name: Run Strix AI Tests - VLM
        if: env.TEST_CATEGORY == 'vlm'
        run: |
          unset VIRTUAL_ENV
          /usr/bin/python3 -m pytest tests/strix_ai/vlm/ -v -s \
            --junit-xml=test-results-vlm.xml \
            || exit 0
      
      - name: Run Strix AI Tests - VLA
        if: env.TEST_CATEGORY == 'vla'
        run: |
          unset VIRTUAL_ENV
          /usr/bin/python3 -m pytest tests/strix_ai/vla/ -v -s \
            --junit-xml=test-results-vla.xml \
            || exit 0
      
      - name: Run Strix AI Tests - ViT
        if: env.TEST_CATEGORY == 'vit'
        run: |
          unset VIRTUAL_ENV
          /usr/bin/python3 -m pytest tests/strix_ai/vit/ -v -s \
            --junit-xml=test-results-vit.xml \
            || exit 0
      
      - name: Run Strix AI Tests - CV
        if: env.TEST_CATEGORY == 'cv'
        run: |
          unset VIRTUAL_ENV
          /usr/bin/python3 -m pytest tests/strix_ai/cv/ -v -s \
            --junit-xml=test-results-cv.xml \
            || exit 0
      
      - name: Run Strix AI Tests - Optimization
        if: env.TEST_CATEGORY == 'optimization'
        run: |
          unset VIRTUAL_ENV
          /usr/bin/python3 -m pytest tests/strix_ai/optimization/ -v -s \
            --junit-xml=test-results-optimization.xml \
            || exit 0
      
      - name: Run Strix AI Tests - Quick Smoke Tests
        if: env.TEST_CATEGORY == 'quick'
        run: |
          unset VIRTUAL_ENV
          /usr/bin/python3 -m pytest tests/strix_ai/ -v -s \
            -m "quick" \
            --junit-xml=test-results-quick.xml \
            || exit 0
      
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: strix-ai-test-results-${{ env.PLATFORM }}-${{ env.AMDGPU_FAMILIES }}-${{ env.TEST_CATEGORY }}
          path: test-results-*.xml
          retention-days: 30
      
      - name: Test Summary
        if: always()
        run: |
          echo "=== Strix AI Test Summary ==="
          echo "Trigger: ${{ github.event_name }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Platform: ${{ env.PLATFORM }}"
          echo "Strix Variant: ${{ env.AMDGPU_FAMILIES }}"
          echo "Test Category: ${{ env.TEST_CATEGORY }}"
          echo "Test Type: ${{ env.TEST_TYPE }}"
          echo "Runner: ${{ runner.name }}"
          echo "Status: ${{ job.status }}"
          
          if [ -f test-results-*.xml ]; then
            echo "Test results saved to artifacts"
          fi

  # Optional: Run on multiple platforms in parallel
  strix_ai_test_matrix:
    name: 'Strix AI Matrix Tests'
    # Only run if triggered manually with 'all' category and 'full' test type
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.test_category == 'all' && github.event.inputs.test_type == 'full'
    strategy:
      fail-fast: false
      matrix:
        platform: [linux, windows]
        category: [vlm, vla, vit, cv]
    runs-on: ${{ matrix.platform == 'linux' && 'linux-strix-halo-gpu-rocm' || 'windows-strix-halo-gpu-rocm' }}
    timeout-minutes: 60
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install Dependencies
        run: |
          unset VIRTUAL_ENV
          /usr/bin/python3 -m pip install pytest transformers ultralytics opencv-python pillow torch torchvision --user
      
      - name: Run Tests
        env:
          AMDGPU_FAMILIES: ${{ github.event.inputs.strix_variant || 'gfx1151' }}
        run: |
          unset VIRTUAL_ENV
          /usr/bin/python3 -m pytest tests/strix_ai/${{ matrix.category }}/ -v

