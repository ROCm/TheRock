name: Test External Repo Integration

# This workflow tests external repository CI integration by overriding the
# github.repository value that is normally used for repository detection.
#
# Automatically runs on PRs that modify CI infrastructure files.
#
# TODO: Add workflow_dispatch for manual testing with project/test filtering options

on:
  pull_request:
    paths:
      - '.github/workflows/ci*.yml'
      - '.github/workflows/setup.yml'
      - '.github/workflows/build_*.yml'
      - '.github/workflows/test_*.yml'
      - '.github/workflows/test_external_repo_integration.yml'
      - '.github/actions/setup_test_environment/**'
      - 'build_tools/github_actions/configure_ci.py'
      - 'build_tools/github_actions/detect_external_repo_config.py'
      - 'build_tools/github_actions/detect_external_projects.py'
      - 'build_tools/github_actions/external_repo_project_maps.py'
      - 'build_tools/github_actions/fetch_test_configurations.py'
      - 'build_tools/github_actions/amdgpu_family_matrix.py'
      - 'build_tools/github_actions/github_actions_utils.py'
      - 'build_tools/install_rocm_from_artifacts.py'
      - 'build_tools/fetch_artifacts.py'

permissions:
  contents: read

jobs:
  # Test rocm-libraries integration
  test-rocm-libraries:
    name: "Test rocm-libraries Integration"
    uses: ./.github/workflows/ci.yml
    secrets: inherit
    with:
      external_source_checkout: true
      therock_ref: ${{ github.ref }}
      repository_override: "ROCm/rocm-libraries"
      # Test with rocprim (fast build) to simulate a typical PR scenario
      projects: 'projects/rocprim'
      linux_amdgpu_families: "gfx94X"
      windows_amdgpu_families: "gfx110X"
    permissions:
      contents: read
      id-token: write

  # Test rocm-systems integration
  test-rocm-systems:
    name: "Test rocm-systems Integration"
    uses: ./.github/workflows/ci.yml
    secrets: inherit
    with:
      external_source_checkout: true
      therock_ref: ${{ github.ref }}
      repository_override: "ROCm/rocm-systems"
      # Test with clr (core component) to simulate a typical PR scenario
      projects: 'projects/clr'
      linux_amdgpu_families: "gfx94X"
      windows_amdgpu_families: "gfx110X"
    permissions:
      contents: read
      id-token: write
