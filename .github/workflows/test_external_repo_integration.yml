name: Test External Repo Integration

# This workflow tests external repository CI integration by overriding the
# github.repository value that is normally used for repository detection.
#
# Automatically runs on PRs that modify CI infrastructure files.
# Can also be manually triggered with optional project filtering.

on:
  pull_request:
    paths:
      - '.github/workflows/ci*.yml'
      - '.github/workflows/setup.yml'
      - '.github/workflows/build_*.yml'
      - 'build_tools/github_actions/configure_ci.py'
      - 'build_tools/github_actions/detect_external_repo_config.py'
      - 'build_tools/github_actions/detect_external_projects.py'
      - 'build_tools/github_actions/external_repo_project_maps.py'
      - 'build_tools/github_actions/amdgpu_family_matrix.py'
  workflow_dispatch:
    inputs:
      test_scenario:
        type: choice
        description: "Which external repo to test"
        required: true
        default: "rocm-libraries"
        options:
          - rocm-libraries
          - rocm-systems
          - both
      rocm_libraries_projects:
        type: string
        description: "rocm-libraries: Override project detection (e.g., 'projects/rocprim,projects/hipcub'). Blank = auto-detect."
        default: ""
      rocm_systems_projects:
        type: string
        description: "rocm-systems: Override project detection (e.g., 'projects/clr,projects/rocminfo'). Blank = auto-detect."
        default: ""

permissions:
  contents: read

jobs:
  # Test rocm-libraries integration
  test-rocm-libraries:
    name: "Test rocm-libraries Integration"
    # Run on workflow_dispatch with selected scenario, or on PR (tests both)
    if: >-
      ${{ 
        (github.event_name == 'workflow_dispatch' && (inputs.test_scenario == 'rocm-libraries' || inputs.test_scenario == 'both')) ||
        (github.event_name == 'pull_request')
      }}
    uses: ./.github/workflows/ci.yml
    secrets: inherit
    with:
      external_source_checkout: true
      repository_override: "ROCm/rocm-libraries"
      projects: ${{ inputs.rocm_libraries_projects || '' }}
    permissions:
      contents: read
      id-token: write

  # Test rocm-systems integration  
  test-rocm-systems:
    name: "Test rocm-systems Integration"
    # Run on workflow_dispatch with selected scenario, or on PR (tests both)
    if: >-
      ${{ 
        (github.event_name == 'workflow_dispatch' && (inputs.test_scenario == 'rocm-systems' || inputs.test_scenario == 'both')) ||
        (github.event_name == 'pull_request')
      }}
    uses: ./.github/workflows/ci.yml
    secrets: inherit
    with:
      external_source_checkout: true
      repository_override: "ROCm/rocm-systems"
      projects: ${{ inputs.rocm_systems_projects || '' }}
    permissions:
      contents: read
      id-token: write
