name: Setup for External Repos

on:
  workflow_call:
    inputs:
      matrix_module_path:
        type: string
        description: "Path to therock_matrix.py in calling repo"
        default: ".github/scripts/therock_matrix.py"
      therock_ref:
        type: string
        description: "TheRock git ref to use"
        default: "main"
    outputs:
      linux_variants:
        description: "Linux build variants matrix"
        value: ${{ jobs.setup.outputs.linux_variants }}
      windows_variants:
        description: "Windows build variants matrix"
        value: ${{ jobs.setup.outputs.windows_variants }}
      test_type:
        description: "Test type (smoke or full)"
        value: ${{ jobs.setup.outputs.test_type }}
      enable_build_jobs:
        description: "Whether to enable build jobs"
        value: ${{ jobs.setup.outputs.enable_build_jobs }}

permissions:
  contents: read

jobs:
  setup:
    runs-on: ubuntu-24.04
    outputs:
      linux_variants: ${{ steps.configure.outputs.linux_variants }}
      windows_variants: ${{ steps.configure.outputs.windows_variants }}
      test_type: ${{ steps.configure.outputs.test_type }}
      enable_build_jobs: ${{ steps.configure.outputs.enable_build_jobs }}
    steps:
      - name: Checkout calling repo
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          path: source-repo
          fetch-depth: 2

      - name: Checkout TheRock
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          repository: ROCm/TheRock
          path: TheRock
          ref: ${{ inputs.therock_ref }}

      - name: Setup Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          pip install pydantic requests

      - name: Configure CI
        id: configure
        env:
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_REF: ${{ github.ref }}
          BASE_REF: HEAD^
          PR_LABELS: ${{ toJSON(github.event.pull_request.labels) }}
          EXTERNAL_MATRIX_MODULE: ${{ github.workspace }}/source-repo/${{ inputs.matrix_module_path }}
        run: |
          cd source-repo
          python ../TheRock/build_tools/github_actions/configure_ci.py \
            --external-matrix-module "$EXTERNAL_MATRIX_MODULE"
