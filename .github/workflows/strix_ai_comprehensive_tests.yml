name: Strix AI/ML Comprehensive Testing

# Comprehensive testing for all Strix AI/ML models and market segments
on:
  # Automatic triggers
  push:
    branches:
      - 'users/rponnuru/strix_poc'
    paths:
      - 'tests/strix_ai/**'
      - '.github/workflows/strix_ai*.yml'
  
  pull_request:
    branches:
      - 'main'
      - 'develop'
    paths:
      - 'tests/strix_ai/**'
      - '.github/workflows/strix_ai*.yml'
  
  # Manual trigger with comprehensive options
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to test'
        required: true
        type: choice
        options:
          - linux
          - windows
        default: 'linux'
      
      strix_variant:
        description: 'Strix GPU variant'
        required: true
        type: choice
        options:
          - gfx1150  # Strix Point
          - gfx1151  # Strix Halo
        default: 'gfx1151'
      
      rocm_version:
        description: 'ROCm version'
        required: true
        type: choice
        options:
          - '6.4.4'
          - '7.0.2'
        default: '6.4.4'
      
      test_category:
        description: 'Test category to run'
        required: true
        type: choice
        options:
          - all           # Run all tests
          - vlm           # Vision-Language Models
          - vla           # Vision-Language-Action
          - omni          # Multimodal (Omni)
          - instruct      # Instruction Following
          - segmentation  # Segmentation (SAM2)
          - asr           # Speech Recognition
          - diffusion     # Generative AI
          - llm           # Language Models
          - optimization  # Quantization tests
          - profiling     # ROCProfiler tests
          - benchmarks    # Market segment benchmarks
          - quick         # Quick smoke tests
        default: 'quick'
      
      market_segment:
        description: 'Market segment to test (for benchmarks)'
        required: false
        type: choice
        options:
          - all
          - automotive
          - industrial
          - robotics
          - healthcare
        default: 'all'
      
      test_type:
        description: 'Test execution type'
        required: true
        type: choice
        options:
          - functional    # Correctness only
          - performance   # Performance metrics
          - full          # Functional + Performance
        default: 'functional'
      
      runner_label:
        description: 'GitHub runner label (leave default unless testing)'
        required: false
        type: string
        default: ''

permissions:
  contents: read

jobs:
  # ===========================================================================
  # Job 1: VLM (Vision-Language Models) Tests
  # ===========================================================================
  strix_vlm_tests:
    name: Strix VLM Tests (Qwen-VL, CLIP/BLIP)
    if: github.event.inputs.test_category == 'all' || github.event.inputs.test_category == 'vlm' || github.event_name != 'workflow_dispatch'
    runs-on: ${{ github.event.inputs.runner_label || ((github.event.inputs.platform || 'linux') == 'linux' && 'linux-strix-halo-gpu-rocm' || 'windows-strix-halo-gpu-rocm') }}
    timeout-minutes: 60
    
    defaults:
      run:
        shell: bash
    
    env:
      AMDGPU_FAMILIES: ${{ github.event.inputs.strix_variant || 'gfx1151' }}
      ROCM_VERSION: ${{ github.event.inputs.rocm_version || '6.4.4' }}
      TEST_CATEGORY: 'vlm'
      TEST_TYPE: ${{ github.event.inputs.test_type || 'functional' }}
      PYTHONUNBUFFERED: 1
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          repository: "ROCm/TheRock"
          ref: ${{ github.ref }}
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install ROCm from Artifacts
        run: |
          echo "=== Installing ROCm ${{ env.ROCM_VERSION }} ==="
          python build_tools/install_rocm_from_artifacts.py \
            --release ${{ env.ROCM_VERSION }} \
            --amdgpu-family ${{ env.AMDGPU_FAMILIES }} \
            --output-dir /opt/rocm
          
          echo "PATH=/opt/rocm/bin:$PATH" >> $GITHUB_ENV
          echo "LD_LIBRARY_PATH=/opt/rocm/lib:$LD_LIBRARY_PATH" >> $GITHUB_ENV
      
      - name: Verify GPU Access
        run: |
          echo "=== GPU Information ==="
          /opt/rocm/bin/rocminfo | head -50
          ls -la /dev/kfd /dev/dri
      
      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install pytest pytest-check
          pip install torch torchvision --index-url https://download.pytorch.org/whl/rocm6.2
          pip install transformers accelerate ultralytics opencv-python pillow timm einops
      
      - name: Verify PyTorch GPU
        run: |
          python3 -c "import torch; print('PyTorch:', torch.__version__); print('CUDA available:', torch.cuda.is_available()); print('Device:', torch.cuda.get_device_name(0) if torch.cuda.is_available() else 'None')"
      
      - name: Run VLM Functional Tests
        if: env.TEST_TYPE == 'functional' || env.TEST_TYPE == 'full'
        run: |
          pytest tests/strix_ai/vlm/ -v -s -m "functional" \
            --junit-xml=test-results-vlm-functional.xml || exit 0
      
      - name: Run VLM Performance Tests
        if: env.TEST_TYPE == 'performance' || env.TEST_TYPE == 'full'
        run: |
          pytest tests/strix_ai/vlm/ -v -s -m "performance" \
            --junit-xml=test-results-vlm-performance.xml || exit 0
      
      - name: Upload VLM Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: strix-vlm-test-results-${{ env.AMDGPU_FAMILIES }}
          path: test-results-vlm-*.xml
          if-no-files-found: warn
          retention-days: 30

  # ===========================================================================
  # Job 2: VLA (Vision-Language-Action) Tests
  # ===========================================================================
  strix_vla_tests:
    name: Strix VLA Tests (OpenVLA, Pi0)
    if: github.event.inputs.test_category == 'all' || github.event.inputs.test_category == 'vla'
    runs-on: ${{ github.event.inputs.runner_label || ((github.event.inputs.platform || 'linux') == 'linux' && 'linux-strix-halo-gpu-rocm' || 'windows-strix-halo-gpu-rocm') }}
    timeout-minutes: 60
    
    defaults:
      run:
        shell: bash
    
    env:
      AMDGPU_FAMILIES: ${{ github.event.inputs.strix_variant || 'gfx1151' }}
      ROCM_VERSION: ${{ github.event.inputs.rocm_version || '6.4.4' }}
      TEST_CATEGORY: 'vla'
      TEST_TYPE: ${{ github.event.inputs.test_type || 'functional' }}
      PYTHONUNBUFFERED: 1
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install ROCm and Dependencies
        run: |
          python build_tools/install_rocm_from_artifacts.py \
            --release ${{ env.ROCM_VERSION }} \
            --amdgpu-family ${{ env.AMDGPU_FAMILIES }} \
            --output-dir /opt/rocm
          echo "PATH=/opt/rocm/bin:$PATH" >> $GITHUB_ENV
          pip install --upgrade pip
          pip install pytest pytest-check torch transformers auto-gptq
      
      - name: Run VLA Tests
        run: |
          pytest tests/strix_ai/vla/ -v -s \
            --junit-xml=test-results-vla.xml || exit 0
      
      - name: Upload VLA Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: strix-vla-test-results-${{ env.AMDGPU_FAMILIES }}
          path: test-results-vla*.xml
          retention-days: 30

  # ===========================================================================
  # Job 3: Omni (Multimodal) Tests
  # ===========================================================================
  strix_omni_tests:
    name: Strix Omni Tests (Qwen Omni)
    if: github.event.inputs.test_category == 'all' || github.event.inputs.test_category == 'omni'
    runs-on: ${{ github.event.inputs.runner_label || 'linux-strix-halo-gpu-rocm' }}
    timeout-minutes: 60
    
    defaults:
      run:
        shell: bash
    
    env:
      AMDGPU_FAMILIES: ${{ github.event.inputs.strix_variant || 'gfx1151' }}
      ROCM_VERSION: ${{ github.event.inputs.rocm_version || '6.4.4' }}
      TEST_CATEGORY: 'omni'
      PYTHONUNBUFFERED: 1
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install ROCm and Dependencies
        run: |
          python build_tools/install_rocm_from_artifacts.py \
            --release ${{ env.ROCM_VERSION }} \
            --amdgpu-family ${{ env.AMDGPU_FAMILIES }} \
            --output-dir /opt/rocm
          echo "PATH=/opt/rocm/bin:$PATH" >> $GITHUB_ENV
          pip install --upgrade pip pytest torch transformers
      
      - name: Run Omni Tests
        run: |
          pytest tests/strix_ai/omni/ -v -s \
            --junit-xml=test-results-omni.xml || exit 0
      
      - name: Upload Omni Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: strix-omni-test-results
          path: test-results-omni*.xml
          retention-days: 30

  # ===========================================================================
  # Job 4: Instruct (Instruction Following) Tests
  # ===========================================================================
  strix_instruct_tests:
    name: Strix Instruct Tests (Qwen3-Instruct)
    if: github.event.inputs.test_category == 'all' || github.event.inputs.test_category == 'instruct' || github.event_name != 'workflow_dispatch'
    runs-on: ${{ github.event.inputs.runner_label || 'linux-strix-halo-gpu-rocm' }}
    timeout-minutes: 60
    
    defaults:
      run:
        shell: bash
    
    env:
      AMDGPU_FAMILIES: ${{ github.event.inputs.strix_variant || 'gfx1151' }}
      ROCM_VERSION: ${{ github.event.inputs.rocm_version || '6.4.4' }}
      TEST_CATEGORY: 'instruct'
      TEST_TYPE: ${{ github.event.inputs.test_type || 'functional' }}
      PYTHONUNBUFFERED: 1
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install ROCm and Dependencies
        run: |
          python build_tools/install_rocm_from_artifacts.py \
            --release ${{ env.ROCM_VERSION }} \
            --amdgpu-family ${{ env.AMDGPU_FAMILIES }} \
            --output-dir /opt/rocm
          echo "PATH=/opt/rocm/bin:$PATH" >> $GITHUB_ENV
          pip install --upgrade pip pytest torch transformers accelerate
      
      - name: Run Instruct Tests
        run: |
          pytest tests/strix_ai/instruct/ -v -s \
            --junit-xml=test-results-instruct.xml || exit 0
      
      - name: Upload Instruct Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: strix-instruct-test-results
          path: test-results-instruct*.xml
          retention-days: 30

  # ===========================================================================
  # Job 5: Segmentation Tests (SAM2)
  # ===========================================================================
  strix_segmentation_tests:
    name: Strix Segmentation Tests (SAM2)
    if: github.event.inputs.test_category == 'all' || github.event.inputs.test_category == 'segmentation' || github.event_name != 'workflow_dispatch'
    runs-on: ${{ github.event.inputs.runner_label || 'linux-strix-halo-gpu-rocm' }}
    timeout-minutes: 60
    
    defaults:
      run:
        shell: bash
    
    env:
      AMDGPU_FAMILIES: ${{ github.event.inputs.strix_variant || 'gfx1151' }}
      ROCM_VERSION: ${{ github.event.inputs.rocm_version || '6.4.4' }}
      TEST_CATEGORY: 'segmentation'
      PYTHONUNBUFFERED: 1
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install ROCm and Dependencies
        run: |
          python build_tools/install_rocm_from_artifacts.py \
            --release ${{ env.ROCM_VERSION }} \
            --amdgpu-family ${{ env.AMDGPU_FAMILIES }} \
            --output-dir /opt/rocm
          echo "PATH=/opt/rocm/bin:$PATH" >> $GITHUB_ENV
          pip install --upgrade pip pytest torch opencv-python pillow
      
      - name: Run Segmentation Tests
        run: |
          pytest tests/strix_ai/segmentation/ -v -s \
            --junit-xml=test-results-segmentation.xml || exit 0
      
      - name: Upload Segmentation Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: strix-segmentation-test-results
          path: test-results-segmentation*.xml
          retention-days: 30

  # ===========================================================================
  # Job 6: ASR (Speech Recognition) Tests
  # ===========================================================================
  strix_asr_tests:
    name: Strix ASR Tests (zipformer, crossformer)
    if: github.event.inputs.test_category == 'all' || github.event.inputs.test_category == 'asr'
    runs-on: ${{ github.event.inputs.runner_label || 'linux-strix-halo-gpu-rocm' }}
    timeout-minutes: 60
    
    defaults:
      run:
        shell: bash
    
    env:
      AMDGPU_FAMILIES: ${{ github.event.inputs.strix_variant || 'gfx1151' }}
      ROCM_VERSION: ${{ github.event.inputs.rocm_version || '6.4.4' }}
      TEST_CATEGORY: 'asr'
      PYTHONUNBUFFERED: 1
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install ROCm and Dependencies
        run: |
          python build_tools/install_rocm_from_artifacts.py \
            --release ${{ env.ROCM_VERSION }} \
            --amdgpu-family ${{ env.AMDGPU_FAMILIES }} \
            --output-dir /opt/rocm
          echo "PATH=/opt/rocm/bin:$PATH" >> $GITHUB_ENV
          pip install --upgrade pip pytest torch
      
      - name: Run ASR Tests
        run: |
          pytest tests/strix_ai/asr/ -v -s \
            --junit-xml=test-results-asr.xml || exit 0
      
      - name: Upload ASR Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: strix-asr-test-results
          path: test-results-asr*.xml
          retention-days: 30

  # ===========================================================================
  # Job 7: Diffusion (Generative AI) Tests
  # ===========================================================================
  strix_diffusion_tests:
    name: Strix Diffusion Tests (Flux, SD3)
    if: github.event.inputs.test_category == 'all' || github.event.inputs.test_category == 'diffusion'
    runs-on: ${{ github.event.inputs.runner_label || 'linux-strix-halo-gpu-rocm' }}
    timeout-minutes: 60
    
    defaults:
      run:
        shell: bash
    
    env:
      AMDGPU_FAMILIES: ${{ github.event.inputs.strix_variant || 'gfx1151' }}
      ROCM_VERSION: ${{ github.event.inputs.rocm_version || '6.4.4' }}
      TEST_CATEGORY: 'diffusion'
      PYTHONUNBUFFERED: 1
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install ROCm and Dependencies
        run: |
          python build_tools/install_rocm_from_artifacts.py \
            --release ${{ env.ROCM_VERSION }} \
            --amdgpu-family ${{ env.AMDGPU_FAMILIES }} \
            --output-dir /opt/rocm
          echo "PATH=/opt/rocm/bin:$PATH" >> $GITHUB_ENV
          pip install --upgrade pip pytest torch
      
      - name: Run Diffusion Tests
        run: |
          pytest tests/strix_ai/diffusion/ -v -s \
            --junit-xml=test-results-diffusion.xml || exit 0
      
      - name: Upload Diffusion Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: strix-diffusion-test-results
          path: test-results-diffusion*.xml
          retention-days: 30

  # ===========================================================================
  # Job 8: LLM (Language Models) Tests
  # ===========================================================================
  strix_llm_tests:
    name: Strix LLM Tests (Llama, Deepseek)
    if: github.event.inputs.test_category == 'all' || github.event.inputs.test_category == 'llm'
    runs-on: ${{ github.event.inputs.runner_label || 'linux-strix-halo-gpu-rocm' }}
    timeout-minutes: 60
    
    defaults:
      run:
        shell: bash
    
    env:
      AMDGPU_FAMILIES: ${{ github.event.inputs.strix_variant || 'gfx1151' }}
      ROCM_VERSION: ${{ github.event.inputs.rocm_version || '6.4.4' }}
      TEST_CATEGORY: 'llm'
      PYTHONUNBUFFERED: 1
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install ROCm and Dependencies
        run: |
          python build_tools/install_rocm_from_artifacts.py \
            --release ${{ env.ROCM_VERSION }} \
            --amdgpu-family ${{ env.AMDGPU_FAMILIES }} \
            --output-dir /opt/rocm
          echo "PATH=/opt/rocm/bin:$PATH" >> $GITHUB_ENV
          pip install --upgrade pip pytest torch transformers
      
      - name: Run LLM Tests
        run: |
          pytest tests/strix_ai/llm/ -v -s \
            --junit-xml=test-results-llm.xml || exit 0
      
      - name: Upload LLM Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: strix-llm-test-results
          path: test-results-llm*.xml
          retention-days: 30

  # ===========================================================================
  # Job 9: Optimization (Quantization) Tests
  # ===========================================================================
  strix_optimization_tests:
    name: Strix Optimization Tests (AWQ, GPTQ)
    if: github.event.inputs.test_category == 'all' || github.event.inputs.test_category == 'optimization'
    runs-on: ${{ github.event.inputs.runner_label || 'linux-strix-halo-gpu-rocm' }}
    timeout-minutes: 60
    
    defaults:
      run:
        shell: bash
    
    env:
      AMDGPU_FAMILIES: ${{ github.event.inputs.strix_variant || 'gfx1151' }}
      ROCM_VERSION: ${{ github.event.inputs.rocm_version || '6.4.4' }}
      TEST_CATEGORY: 'optimization'
      PYTHONUNBUFFERED: 1
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install ROCm and Dependencies
        run: |
          python build_tools/install_rocm_from_artifacts.py \
            --release ${{ env.ROCM_VERSION }} \
            --amdgpu-family ${{ env.AMDGPU_FAMILIES }} \
            --output-dir /opt/rocm
          echo "PATH=/opt/rocm/bin:$PATH" >> $GITHUB_ENV
          pip install --upgrade pip pytest torch transformers auto-gptq
      
      - name: Run Optimization Tests
        run: |
          pytest tests/strix_ai/optimization/ -v -s \
            --junit-xml=test-results-optimization.xml || exit 0
      
      - name: Upload Optimization Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: strix-optimization-test-results
          path: test-results-optimization*.xml
          retention-days: 30

  # ===========================================================================
  # Job 10: Profiling Tests (ROCProfiler v3)
  # ===========================================================================
  strix_profiling_tests:
    name: Strix Profiling Tests (ROCProfiler v3)
    if: github.event.inputs.test_category == 'all' || github.event.inputs.test_category == 'profiling'
    runs-on: ${{ github.event.inputs.runner_label || 'linux-strix-halo-gpu-rocm' }}
    timeout-minutes: 90
    
    defaults:
      run:
        shell: bash
    
    env:
      AMDGPU_FAMILIES: ${{ github.event.inputs.strix_variant || 'gfx1151' }}
      ROCM_VERSION: ${{ github.event.inputs.rocm_version || '6.4.4' }}
      TEST_CATEGORY: 'profiling'
      PYTHONUNBUFFERED: 1
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install ROCm and Dependencies
        run: |
          python build_tools/install_rocm_from_artifacts.py \
            --release ${{ env.ROCM_VERSION }} \
            --amdgpu-family ${{ env.AMDGPU_FAMILIES }} \
            --output-dir /opt/rocm
          echo "PATH=/opt/rocm/bin:$PATH" >> $GITHUB_ENV
          pip install --upgrade pip pytest torch transformers
      
      - name: Verify rocprofv3
        run: |
          which rocprofv3 || echo "rocprofv3 not found"
          rocprofv3 --version || echo "rocprofv3 version check failed"
      
      - name: Run Profiling Tests
        run: |
          pytest tests/strix_ai/profiling/ -v -s \
            --junit-xml=test-results-profiling.xml || exit 0
      
      - name: Upload Profiling Results and Traces
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: strix-profiling-test-results
          path: |
            test-results-profiling*.xml
            *_traces/
            *.pftrace
          retention-days: 30

  # ===========================================================================
  # Job 11: Market Segment Benchmarks
  # ===========================================================================
  strix_benchmark_tests:
    name: Strix Benchmarks (${{ github.event.inputs.market_segment || 'all' }})
    if: github.event.inputs.test_category == 'all' || github.event.inputs.test_category == 'benchmarks'
    runs-on: ${{ github.event.inputs.runner_label || 'linux-strix-halo-gpu-rocm' }}
    timeout-minutes: 120
    
    defaults:
      run:
        shell: bash
    
    env:
      AMDGPU_FAMILIES: ${{ github.event.inputs.strix_variant || 'gfx1151' }}
      ROCM_VERSION: ${{ github.event.inputs.rocm_version || '6.4.4' }}
      TEST_CATEGORY: 'benchmarks'
      MARKET_SEGMENT: ${{ github.event.inputs.market_segment || 'all' }}
      PYTHONUNBUFFERED: 1
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install ROCm and Dependencies
        run: |
          python build_tools/install_rocm_from_artifacts.py \
            --release ${{ env.ROCM_VERSION }} \
            --amdgpu-family ${{ env.AMDGPU_FAMILIES }} \
            --output-dir /opt/rocm
          echo "PATH=/opt/rocm/bin:$PATH" >> $GITHUB_ENV
          pip install --upgrade pip pytest torch transformers ultralytics opencv-python
      
      - name: Run Automotive Benchmarks
        if: env.MARKET_SEGMENT == 'all' || env.MARKET_SEGMENT == 'automotive'
        run: |
          pytest tests/strix_ai/benchmarks/automotive_bench.py -v -s \
            --junit-xml=benchmark-results-automotive.xml || exit 0
      
      - name: Run Industrial Benchmarks
        if: env.MARKET_SEGMENT == 'all' || env.MARKET_SEGMENT == 'industrial'
        run: |
          pytest tests/strix_ai/benchmarks/industrial_bench.py -v -s \
            --junit-xml=benchmark-results-industrial.xml || exit 0
      
      - name: Run Robotics Benchmarks
        if: env.MARKET_SEGMENT == 'all' || env.MARKET_SEGMENT == 'robotics'
        run: |
          pytest tests/strix_ai/benchmarks/robotics_bench.py -v -s \
            --junit-xml=benchmark-results-robotics.xml || exit 0
      
      - name: Run Healthcare Benchmarks
        if: env.MARKET_SEGMENT == 'all' || env.MARKET_SEGMENT == 'healthcare'
        run: |
          pytest tests/strix_ai/benchmarks/healthcare_bench.py -v -s \
            --junit-xml=benchmark-results-healthcare.xml || exit 0
      
      - name: Upload Benchmark Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: strix-benchmark-results-${{ env.MARKET_SEGMENT }}
          path: benchmark-results-*.xml
          retention-days: 30

  # ===========================================================================
  # Job 12: Quick Smoke Tests
  # ===========================================================================
  strix_quick_tests:
    name: Strix Quick Smoke Tests
    if: github.event.inputs.test_category == 'quick' || github.event_name != 'workflow_dispatch'
    runs-on: ${{ github.event.inputs.runner_label || 'linux-strix-halo-gpu-rocm' }}
    timeout-minutes: 30
    
    defaults:
      run:
        shell: bash
    
    env:
      AMDGPU_FAMILIES: ${{ github.event.inputs.strix_variant || 'gfx1151' }}
      ROCM_VERSION: ${{ github.event.inputs.rocm_version || '6.4.4' }}
      TEST_CATEGORY: 'quick'
      PYTHONUNBUFFERED: 1
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install ROCm and Dependencies
        run: |
          python build_tools/install_rocm_from_artifacts.py \
            --release ${{ env.ROCM_VERSION }} \
            --amdgpu-family ${{ env.AMDGPU_FAMILIES }} \
            --output-dir /opt/rocm
          echo "PATH=/opt/rocm/bin:$PATH" >> $GITHUB_ENV
          pip install --upgrade pip pytest torch transformers ultralytics opencv-python pillow
      
      - name: Run Quick Smoke Tests
        run: |
          pytest tests/strix_ai/ -v -s -m "quick" \
            --junit-xml=test-results-quick-smoke.xml || exit 0
      
      - name: Upload Quick Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: strix-quick-test-results
          path: test-results-quick*.xml
          retention-days: 30

  # ===========================================================================
  # Job 13: Test Summary Report
  # ===========================================================================
  test_summary:
    name: Generate Test Summary Report
    if: always()
    needs: [strix_vlm_tests, strix_vla_tests, strix_omni_tests, strix_instruct_tests, 
            strix_segmentation_tests, strix_asr_tests, strix_diffusion_tests, 
            strix_llm_tests, strix_optimization_tests, strix_profiling_tests, 
            strix_benchmark_tests, strix_quick_tests]
    runs-on: ubuntu-latest
    
    steps:
      - name: Generate Summary
        run: |
          echo "# Strix AI/ML Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Execution Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Platform**: ${{ github.event.inputs.platform || 'linux' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Strix Variant**: ${{ github.event.inputs.strix_variant || 'gfx1151' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ROCm Version**: ${{ github.event.inputs.rocm_version || '6.4.4' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Test Category**: ${{ github.event.inputs.test_category || 'quick' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Test Type**: ${{ github.event.inputs.test_type || 'functional' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Market Segment**: ${{ github.event.inputs.market_segment || 'all' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Job Status" >> $GITHUB_STEP_SUMMARY
          echo "- VLM Tests: ${{ needs.strix_vlm_tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- VLA Tests: ${{ needs.strix_vla_tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Omni Tests: ${{ needs.strix_omni_tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Instruct Tests: ${{ needs.strix_instruct_tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Segmentation Tests: ${{ needs.strix_segmentation_tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ASR Tests: ${{ needs.strix_asr_tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Diffusion Tests: ${{ needs.strix_diffusion_tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- LLM Tests: ${{ needs.strix_llm_tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Optimization Tests: ${{ needs.strix_optimization_tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Profiling Tests: ${{ needs.strix_profiling_tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Benchmark Tests: ${{ needs.strix_benchmark_tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Quick Tests: ${{ needs.strix_quick_tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download test artifacts to view detailed XML results." >> $GITHUB_STEP_SUMMARY

