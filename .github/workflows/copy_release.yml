name: Copy release to dev bucket

on:
  workflow_dispatch:
    inputs:
      rocm_version:
        description: ROCm version to copy, e.g. 7.0.0rc20250912
        type: string
      amdgpu_family:
        type: choice
        options:
          - gfx101X-dgpu
          - gfx103X-dgpu
          - gfx110X-all
          - gfx1150
          - gfx1151
          - gfx1152
          - gfx1153
          - gfx120X-all
          - gfx90X-dcgpu
          - gfx94X-dcgpu
          - gfx950-dcgpu
        default: gfx94X-dcgpu
      python_version:
        type: choice
        options:
          - 3.11
          - 3.12
          - 3.13
        default: 3.12
      include_torch:
        type: boolean
        default: false
      sourcesubdir:
        type: choice
        options:
          - v2
          - v2-staging
      destsubdir:
        type: string
        default: v2
      sourcebucket:
        type: choice
        options:
          - nightly
          - dev
        default: nightly
      destbucket:
        type: choice
        options:
          - dev
          - nightly
        default: dev
permissions:
  contents: read

jobs:
  copy_python_packages:
    name: Copy ${{ inputs.sourcebucket }} ${{ inputs.sourcesubdir }} -> ${{ inputs.destbucket }} ${{ inputs.destsubdir }} | ${{ inputs.amdgpu_family }} | rocm ${{ inputs.rocm_version }} | py ${{ inputs.python_version }}
    runs-on: ubuntu-24.04
    permissions:
      id-token: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install boto3
        run: pip install boto3

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@8df5847569e6427dd6c4fb1cf565c83acfa8afa7 # v6.0.0
        with:
          aws-region: us-east-2
          role-to-assume: arn:aws:iam::692859939525:role/therock-${{ inputs.destbucket }}-releases

      - name: Select Python version
        run: |
          python build_tools/github_actions/python_to_cp_version.py \
            --python-version ${{ inputs.python_version }}

      - name: Copy ROCm packages between S3 buckets
        run: |
          python3 << 'EOF'
          import boto3, fnmatch
          client = boto3.client('s3')
          src_bucket = 'therock-${{ inputs.sourcebucket }}-python'
          dst_bucket = 'therock-${{ inputs.destbucket }}-python'
          src_prefix = '${{ inputs.sourcesubdir }}/${{ inputs.amdgpu_family }}/'
          dst_prefix = '${{ inputs.destsubdir }}/${{ inputs.amdgpu_family }}/'
          pattern = 'rocm*${{ inputs.rocm_version }}*'
          paginator = client.get_paginator('list_objects_v2')
          for page in paginator.paginate(Bucket=src_bucket, Prefix=src_prefix):
              for obj in page.get('Contents', []):
                  name = obj['Key'].rsplit('/', 1)[-1]
                  if fnmatch.fnmatch(name, pattern):
                      dst_key = f'{dst_prefix}{name}'
                      print(f"Copying s3://{src_bucket}/{obj['Key']} -> s3://{dst_bucket}/{dst_key}")
                      client.copy_object(Bucket=dst_bucket, CopySource={'Bucket': src_bucket, 'Key': obj['Key']}, Key=dst_key)
          EOF

      - name: Copy torch wheels between S3 buckets
        if: ${{ inputs.include_torch }}
        run: |
          python3 << 'EOF'
          import boto3, fnmatch, os
          client = boto3.client('s3')
          src_bucket = 'therock-${{ inputs.sourcebucket }}-python'
          dst_bucket = 'therock-${{ inputs.destbucket }}-python'
          src_prefix = '${{ inputs.sourcesubdir }}/${{ inputs.amdgpu_family }}/'
          dst_prefix = '${{ inputs.destsubdir }}/${{ inputs.amdgpu_family }}/'
          pattern = f"*torch*${{ inputs.rocm_version }}*{os.environ['cp_version']}*"
          paginator = client.get_paginator('list_objects_v2')
          for page in paginator.paginate(Bucket=src_bucket, Prefix=src_prefix):
              for obj in page.get('Contents', []):
                  name = obj['Key'].rsplit('/', 1)[-1]
                  if fnmatch.fnmatch(name, pattern):
                      dst_key = f'{dst_prefix}{name}'
                      print(f"Copying s3://{src_bucket}/{obj['Key']} -> s3://{dst_bucket}/{dst_key}")
                      client.copy_object(Bucket=dst_bucket, CopySource={'Bucket': src_bucket, 'Key': obj['Key']}, Key=dst_key)
          EOF

      - name: (Re-)Generate Python package release index
        env:
          S3_BUCKET_PY: "therock-${{ inputs.destbucket }}-python"
          CUSTOM_PREFIX: "${{ inputs.destsubdir }}/${{ inputs.amdgpu_family }}"
        run: |
          pip install boto3 packaging
          python ./build_tools/third_party/s3_management/manage.py ${CUSTOM_PREFIX}
