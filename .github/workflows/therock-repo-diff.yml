name: Commit Diff Report

on:
  push:
    branches:
      - 'amd/hsivasun/submodule-reports'
  workflow_dispatch:
    inputs:
      start_commit:
        description: 'Start Commit SHA or Workflow ID'
        required: true
        type: string
      end_commit:
        description: 'End Commit SHA or Workflow ID'
        required: true
        type: string
      workflow_mode:
        description: 'Use Workflow Mode (extract commits from workflow IDs instead of direct commit comparison)'
        required: false
        type: boolean
        default: false
  workflow_call:
    inputs:
      start_commit:
        description: 'Start Commit SHA or Workflow ID'
        required: true
        type: string
      end_commit:
        description: 'End Commit SHA or Workflow ID'
        required: true
        type: string
      workflow_mode:
        description: 'Use Workflow Mode (extract commits from workflow IDs instead of direct commit comparison)'
        required: false
        type: boolean
        default: false

jobs:
  therock-diff-report:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Set commit parameters
        id: commits
        run: |
         # Using set inputs for testing, this step will be removed
          if [ "${{ github.event_name }}" = "push" ]; then
            # Use your test commits when triggered by push
            echo "start_commit=0ae0df6719a6e2096d221d6a61326d8494fa050b" >> $GITHUB_OUTPUT
            echo "end_commit=c834dd20feb0d7228c8a4af4790bb8ed54d8a26c" >> $GITHUB_OUTPUT
            echo "workflow_mode=false" >> $GITHUB_OUTPUT
            echo "Using default test commits for push trigger"
          else
            # Use inputs when triggered manually (workflow_dispatch) or by another workflow (workflow_call)
            echo "start_commit=${{ inputs.start_commit }}" >> $GITHUB_OUTPUT
            echo "end_commit=${{ inputs.end_commit }}" >> $GITHUB_OUTPUT
            echo "workflow_mode=${{ inputs.workflow_mode }}" >> $GITHUB_OUTPUT
            echo "Using inputs from ${{ github.event_name }} trigger"
          fi

      - name: Run TheRock Commit Diff Analysis
        env:
          GITHUB_TOKEN: ${{ github.token }}
          WORKFLOW_MODE: ${{ steps.commits.outputs.workflow_mode }}
        run: |
          cd build_tools/github_actions
          python3 repo-diff.py \
            --start "${{ steps.commits.outputs.start_commit }}" \
            --end "${{ steps.commits.outputs.end_commit }}"

      - name: Upload TheRock HTML Report
        uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874 # v4.0.0
        with:
          name: therock-diff-report
          path: build_tools/github_actions/TheRockReport.html
          retention-days: 15
        if: always()

