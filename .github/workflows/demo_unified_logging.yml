name: Demo - Unified Logging Framework

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Test type (for demo purposes)'
        required: true
        default: 'smoke'
        type: choice
        options:
          - smoke
          - regression
          - full
  push:
    branches:
      - users/rponnuru/logging_poc_2
    paths:
      - 'build_tools/_therock_utils/logging_config.py'
      - 'build_tools/_therock_utils/test_runner.py'
      - 'build_tools/github_actions/test_executable_scripts/test_*.py'
      - '.github/workflows/demo_unified_logging.yml'

permissions:
  contents: read

jobs:
  demo_logging:
    name: 'Demo Unified Logging - ${{ matrix.component }}'
    runs-on: ubuntu-24.04
    timeout-minutes: 45
    container:
      # Use ROCm Docker image with ROCm 7.0 pre-installed
      # Note: No GPU devices needed - this is a logging demo only
      image: rocm/dev-ubuntu-22.04:7.0
    strategy:
      fail-fast: false
      matrix:
        component: [rocroller, rocwmma]
    
    env:
      # Demo environment (no artifact download needed)
      COMPONENT: ${{ matrix.component }}
      TEST_TYPE: ${{ github.event.inputs.test_type || 'smoke' }}
      THEROCK_BIN_DIR: "./build/bin"
      THEROCK_BUILD_DIR: "./build"
      RUNNER_OS: "Linux"
      SHARD_INDEX: "1"
      TOTAL_SHARDS: "1"
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: users/rponnuru/logging_poc_2
      
      - name: Display Logging Framework Info
        run: |
          echo "=========================================="
          echo "ðŸŽ¯ Unified Logging Framework Demo"
          echo "=========================================="
          echo ""
          echo "â„¹ï¸  NOTE: This demonstrates the logging framework"
          echo "   Using mock test binaries to show logging structure"
          echo "   Focus: Observe the unified logging output"
          echo ""
          echo "ðŸ³ Container: rocm/dev-ubuntu-22.04:7.0"
          echo "   ROCm 7.0 pre-installed (no download needed)"
          echo ""
          echo "Component: $COMPONENT"
          echo "Test Type: $TEST_TYPE"
          echo ""
          echo "ðŸ“‹ Logging Features to Observe:"
          echo "  âœ… Unified format: timestamp - logger - level - message"
          echo "  âœ… Context tracking: component, operation, test_type"
          echo "  âœ… Performance timing with timed_operation()"
          echo "  âœ… Structured logging with extra metadata"
          echo "  âœ… Exception handling and error logging"
          echo "  âœ… Works same in local, CI, and GitHub Actions"
          echo ""
          echo "ðŸ“ Key Files:"
          echo "  â€¢ build_tools/_therock_utils/logging_config.py"
          echo "  â€¢ build_tools/_therock_utils/test_runner.py"
          echo "  â€¢ build_tools/github_actions/test_executable_scripts/test_${COMPONENT}.py"
          echo ""
          echo "=========================================="
      
      - name: Show Logging Configuration
        run: |
          echo "ðŸ“ Current Logging Configuration:"
          echo ""
          grep -A 1 "^LOG_FORMAT" build_tools/_therock_utils/logging_config.py || true
          echo ""
          echo "Log Format: timestamp - logger_name - level - message"
          echo "Log Level: INFO (controlled via configure_root_logger)"
          echo ""
      
      - name: Setup Python and Install Dependencies
        run: |
          apt-get update && apt-get install -y python3-pip
          pip3 install --upgrade pip
          pip3 install -r requirements-test.txt
      
      - name: Create Mock Test Binaries for Demo
        run: |
          echo "ðŸ“¦ Creating mock test binaries for logging demo"
          mkdir -p ${THEROCK_BIN_DIR}
          mkdir -p ${THEROCK_BUILD_DIR}/math-libs/BLAS/rocRoller/build/test
          
          if [ "$COMPONENT" = "rocroller" ]; then
            # Create mock GTest binary
            cat > ${THEROCK_BUILD_DIR}/math-libs/BLAS/rocRoller/build/test/rocroller-tests << 'EOF'
          #!/bin/bash
          echo "[==========] Running 5 tests from 2 test suites."
          echo "[----------] Global test environment set-up."
          echo "[----------] 3 tests from ArgumentLoaderTest"
          echo "[ RUN      ] ArgumentLoaderTest.BasicTest"
          sleep 0.1
          echo "[       OK ] ArgumentLoaderTest.BasicTest (10 ms)"
          echo "[ RUN      ] ArgumentLoaderTest.ConfigTest"
          sleep 0.1
          echo "[       OK ] ArgumentLoaderTest.ConfigTest (8 ms)"
          echo "[ RUN      ] ArgumentLoaderTest.ValidationTest"
          sleep 0.1
          echo "[       OK ] ArgumentLoaderTest.ValidationTest (12 ms)"
          echo "[----------] 3 tests from ArgumentLoaderTest (30 ms total)"
          echo ""
          echo "[----------] 2 tests from AssemblerTest"
          echo "[ RUN      ] AssemblerTest.BasicAssembly"
          sleep 0.1
          echo "[       OK ] AssemblerTest.BasicAssembly (15 ms)"
          echo "[ RUN      ] AssemblerTest.ComplexAssembly"
          sleep 0.1
          echo "[       OK ] AssemblerTest.ComplexAssembly (20 ms)"
          echo "[----------] 2 tests from AssemblerTest (35 ms total)"
          echo ""
          echo "[----------] Global test environment tear-down"
          echo "[==========] 5 tests from 2 test suites ran. (65 ms total)"
          echo "[  PASSED  ] 5 tests."
          exit 0
          EOF
            chmod +x ${THEROCK_BUILD_DIR}/math-libs/BLAS/rocRoller/build/test/rocroller-tests
            echo "âœ… Created mock rocroller-tests binary"
          else
            # Create mock CTest directory
            mkdir -p ${THEROCK_BIN_DIR}/rocwmma/regression
            echo "âœ… Created mock rocwmma test directory"
            echo "   (CTest will show 0 tests - demonstrates logging without actual tests)"
          fi
      
      - name: Run ${{ matrix.component }} Test with Unified Logging
        run: |
          echo ""
          echo "=========================================="
          echo "ðŸš€ Running $COMPONENT Tests with Unified Logging"
          echo "=========================================="
          echo ""
          
          # Run the test script which uses unified logging framework
          python3 build_tools/github_actions/test_executable_scripts/test_${COMPONENT}.py
      
      - name: Demo Summary
        if: always()
        run: |
          echo ""
          echo "=========================================="
          echo "ðŸ“Š Demo Summary - $COMPONENT"
          echo "=========================================="
          echo ""
          echo "âœ… Demonstrated Features:"
          echo ""
          echo "1ï¸âƒ£  Unified Logging Configuration"
          echo "   â€¢ Single LOG_FORMAT across all outputs"
          echo "   â€¢ Consistent: timestamp - logger - level - message"
          echo "   â€¢ No environment-specific formatting"
          echo "   â€¢ Same format for console and file output"
          echo ""
          echo "2ï¸âƒ£  TestRunner Integration"
          echo "   â€¢ Captures GTest/CTest output"
          echo "   â€¢ Parses test results"
          echo "   â€¢ Structured logging with context"
          echo "   â€¢ Performance timing built-in"
          echo ""
          echo "3ï¸âƒ£  Context Tracking"
          echo "   â€¢ Component: $COMPONENT"
          echo "   â€¢ Test Type: $TEST_TYPE"
          echo "   â€¢ Operation timing with timed_operation()"
          echo "   â€¢ Structured metadata in log records"
          echo ""
          echo "4ï¸âƒ£  Log Output Features"
          echo "   â€¢ Startup banners with configuration info"
          echo "   â€¢ Binary location and file size logging"
          echo "   â€¢ Test configuration details"
          echo "   â€¢ Exception logging with context"
          echo ""
          echo "5ï¸âƒ£  Simplicity & Portability"
          echo "   â€¢ No GitHub Actions-specific code"
          echo "   â€¢ No JSON formatting complexity"
          echo "   â€¢ No threading locks overhead"
          echo "   â€¢ Works same in local, CI, and GitHub Actions"
          echo "   â€¢ Single unified approach everywhere"
          echo ""
          echo "ðŸ³ Container Info:"
          echo "   â€¢ Image: rocm/dev-ubuntu-22.04:7.0"
          echo "   â€¢ ROCm 7.0 pre-installed"
          echo "   â€¢ No artifact downloads needed"
          echo "   â€¢ Mock tests used for logging demo"
          echo ""
          echo "ðŸ“ Key Files:"
          echo "   â€¢ logging_config.py - Core framework (~410 lines, simplified)"
          echo "   â€¢ test_runner.py - Test execution wrapper"
          echo "   â€¢ test_${COMPONENT}.py - Component test script"
          echo ""
          echo "=========================================="

