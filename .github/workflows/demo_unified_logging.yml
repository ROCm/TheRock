name: Demo - Unified Logging Framework

on:
  workflow_dispatch:
    inputs:
      artifact_run_id:
        description: 'Artifact Run ID to download binaries from'
        required: true
        default: '20151692873'
        type: string
      test_type:
        description: 'Test type'
        required: true
        default: 'smoke'
        type: choice
        options:
          - smoke
          - regression
          - full
  push:
    branches:
      - users/rponnuru/logging_poc_2
    paths:
      - 'build_tools/_therock_utils/logging_config.py'
      - 'build_tools/_therock_utils/test_runner.py'
      - 'build_tools/github_actions/test_executable_scripts/test_*.py'
      - '.github/workflows/demo_unified_logging.yml'

permissions:
  contents: read

jobs:
  demo_logging:
    name: 'Demo Unified Logging - ${{ matrix.component }}'
    runs-on: ubuntu-24.04
    timeout-minutes: 45
    container:
      # Use ROCm Docker image with ROCm 7.0 pre-installed
      image: rocm/dev-ubuntu-22.04:7.0
      options: --device /dev/kfd --device /dev/dri --security-opt seccomp=unconfined --group-add video
    strategy:
      fail-fast: false
      matrix:
        component: [rocroller, rocwmma]
    
    env:
      # Use real artifacts from specified run ID
      ARTIFACT_RUN_ID: ${{ github.event.inputs.artifact_run_id || '20151692873' }}
      ARTIFACT_GROUP: "gfx94X-dcgpu"
      COMPONENT: ${{ matrix.component }}
      TEST_TYPE: ${{ github.event.inputs.test_type || 'smoke' }}
      OUTPUT_ARTIFACTS_DIR: "./build"
      THEROCK_BIN_DIR: "./build/bin"
      THEROCK_BUILD_DIR: "./build"
      AMDGPU_FAMILIES: "gfx94X"
      RUNNER_OS: "Linux"
      SHARD_INDEX: "1"
      TOTAL_SHARDS: "1"
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: users/rponnuru/logging_poc_2
      
      - name: Display Logging Framework Info
        run: |
          echo "=========================================="
          echo "üéØ Unified Logging Framework Demo"
          echo "=========================================="
          echo ""
          echo "üê≥ Container: rocm/dev-ubuntu-22.04:7.0"
          echo "   ROCm 7.0 is pre-installed ‚úÖ"
          echo ""
          echo "Component: $COMPONENT"
          echo "Test Type: $TEST_TYPE"
          echo "Artifact Run ID: $ARTIFACT_RUN_ID"
          echo "Artifact Group: $ARTIFACT_GROUP"
          echo ""
          echo "üìã Logging Features:"
          echo "  ‚úÖ Centralized configuration"
          echo "  ‚úÖ Single unified log format"
          echo "  ‚úÖ Context-aware logging (component, operation)"
          echo "  ‚úÖ Performance timing"
          echo "  ‚úÖ Structured logging"
          echo "  ‚úÖ Exception tracking"
          echo "  ‚úÖ No GitHub Actions-specific code"
          echo ""
          echo "üìÅ Key Files:"
          echo "  ‚Ä¢ build_tools/_therock_utils/logging_config.py"
          echo "  ‚Ä¢ build_tools/_therock_utils/test_runner.py"
          echo "  ‚Ä¢ build_tools/github_actions/test_executable_scripts/test_${COMPONENT}.py"
          echo ""
          echo "=========================================="
      
      - name: Show Logging Configuration
        run: |
          echo "üìù Current Logging Configuration:"
          echo ""
          grep -A 1 "^LOG_FORMAT" build_tools/_therock_utils/logging_config.py || true
          echo ""
          echo "Log Format: timestamp - logger_name - level - message"
          echo "Log Level: INFO (controlled via configure_root_logger)"
          echo ""
          echo "üê≥ Using ROCm Docker image: rocm/dev-ubuntu-22.04:7.0"
          echo "   ‚Ä¢ ROCm pre-installed"
          echo "   ‚Ä¢ No need to download/install ROCm"
          echo "   ‚Ä¢ Only downloading test binaries"
          echo ""
      
      - name: Setup Python and Install Dependencies
        run: |
          apt-get update && apt-get install -y python3-pip
          pip3 install --upgrade pip
          pip3 install -r requirements-test.txt
      
      - name: Download Test Artifacts Only
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          echo "üì¶ Downloading test binaries from Run ID: $ARTIFACT_RUN_ID"
          python3 ./build_tools/install_rocm_from_artifacts.py \
            --run-id=${ARTIFACT_RUN_ID} \
            --artifact-group=${ARTIFACT_GROUP} \
            --output-dir=${OUTPUT_ARTIFACTS_DIR} \
            ${{ matrix.component == 'rocroller' && '--blas --tests' || '--tests' }}
      
      - name: Run ${{ matrix.component }} Test with Unified Logging
        run: |
          echo ""
          echo "=========================================="
          echo "üöÄ Running $COMPONENT Tests with Unified Logging"
          echo "=========================================="
          echo ""
          
          # Run the test script which uses unified logging framework
          python3 build_tools/github_actions/test_executable_scripts/test_${COMPONENT}.py
      
      - name: Demo Summary
        if: always()
        run: |
          echo ""
          echo "=========================================="
          echo "üìä Demo Summary - $COMPONENT"
          echo "=========================================="
          echo ""
          echo "‚úÖ Demonstrated Features:"
          echo ""
          echo "1Ô∏è‚É£  Real Test Execution"
          echo "   ‚Ä¢ Downloaded test binaries from Run ID: $ARTIFACT_RUN_ID"
          echo "   ‚Ä¢ Ran actual $COMPONENT tests (not mocks)"
          echo "   ‚Ä¢ Used real GTest/CTest binaries"
          echo "   ‚Ä¢ ROCm pre-installed in Docker container"
          echo ""
          echo "2Ô∏è‚É£  Unified Logging Configuration"
          echo "   ‚Ä¢ Single LOG_FORMAT across all outputs"
          echo "   ‚Ä¢ Consistent: timestamp - logger - level - message"
          echo "   ‚Ä¢ No environment-specific formatting"
          echo ""
          echo "3Ô∏è‚É£  TestRunner Integration"
          echo "   ‚Ä¢ Captures GTest/CTest output"
          echo "   ‚Ä¢ Parses test results"
          echo "   ‚Ä¢ Structured logging with context"
          echo "   ‚Ä¢ Performance timing built-in"
          echo ""
          echo "4Ô∏è‚É£  Log Output Features"
          echo "   ‚Ä¢ Component tracking ($COMPONENT)"
          echo "   ‚Ä¢ Operation timing with timed_operation()"
          echo "   ‚Ä¢ Test result summaries"
          echo "   ‚Ä¢ Exception logging"
          echo ""
          echo "5Ô∏è‚É£  Simplicity & Efficiency"
          echo "   ‚Ä¢ No GitHub Actions-specific code"
          echo "   ‚Ä¢ No JSON formatting"
          echo "   ‚Ä¢ No threading locks"
          echo "   ‚Ä¢ Works same locally and in CI"
          echo "   ‚Ä¢ ROCm container = faster setup"
          echo ""
          echo "üê≥ Container Info:"
          echo "   ‚Ä¢ Image: rocm/dev-ubuntu-22.04:7.0"
          echo "   ‚Ä¢ ROCm pre-installed (no download needed)"
          echo "   ‚Ä¢ Only downloaded test binaries"
          echo ""
          echo "üìÅ Key Files:"
          echo "   ‚Ä¢ logging_config.py - Core framework (~400 lines)"
          echo "   ‚Ä¢ test_runner.py - Test execution wrapper"
          echo "   ‚Ä¢ test_${COMPONENT}.py - Component test script"
          echo ""
          echo "=========================================="

