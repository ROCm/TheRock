From 0f71a7cf48401bede219434412192e53464b1b21 Mon Sep 17 00:00:00 2001
From: Scott Todd <scott.todd0@gmail.com>
Date: Tue, 20 May 2025 15:13:26 -0700
Subject: [PATCH 13/14] Run hipcc with compatibility flags.

Co-authored-by: Aaryaman Vasishta <jem456.vasishta@gmail.com>
---
 caffe2/CMakeLists.txt    | 4 ++++
 cmake/Dependencies.cmake | 3 +++
 2 files changed, 7 insertions(+)

diff --git a/caffe2/CMakeLists.txt b/caffe2/CMakeLists.txt
index b32c71c8bd6..e76e05c1255 100644
--- a/caffe2/CMakeLists.txt
+++ b/caffe2/CMakeLists.txt
@@ -1699,6 +1699,10 @@ if(USE_ROCM)
     endforeach()
   endif()
 
+  if(WIN32)
+    list(APPEND HIP_CXX_FLAGS "-fms-extensions")
+  endif()
+
   # Call again since Caffe2_HIP_INCLUDE is extended with ATen include dirs.
   hip_include_directories(${Caffe2_HIP_INCLUDE})
 
diff --git a/cmake/Dependencies.cmake b/cmake/Dependencies.cmake
index be45936a8ea..4f6b2e4837c 100644
--- a/cmake/Dependencies.cmake
+++ b/cmake/Dependencies.cmake
@@ -1065,6 +1065,9 @@ if(USE_ROCM)
     list(APPEND HIP_HIPCC_FLAGS --offload-compress)
     if(WIN32)
       add_definitions(-DROCM_ON_WINDOWS)
+      list(APPEND HIP_CXX_FLAGS -fms-extensions)
+      # Suppress warnings about dllexport.
+      list(APPEND HIP_CXX_FLAGS -Wno-ignored-attributes)
     endif()
     add_definitions(-DROCM_VERSION=${ROCM_VERSION_DEV_INT})
     add_definitions(-DTORCH_HIP_VERSION=${TORCH_HIP_VERSION})
-- 
2.47.1.windows.2

